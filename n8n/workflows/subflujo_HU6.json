{
  "name": "subflujo_HU6",
  "nodes": [
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "Registro de Inscritos",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "estado",
              "lookupValue": "ACTIVA"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        64,
        -128
      ],
      "id": "a2d8e43d-d772-4d8b-afba-12900695436a",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "z1XwVw9qRPrCNqVB",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -208,
        -128
      ],
      "id": "39d24554-5d2a-4938-87c8-a8adca739826",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "// Este código filtra usuarios activos cuyo next_run ya fue alcanzado.\n// Espera columnas: estado, next_run, Email, Modalidad, Región, Frecuencia.\n\nfunction parseNextRunToDateUTC(s) {\n  if (!s || typeof s !== 'string') return null;\n  // Convierte \"YYYY-MM-DD HH:mm:ss\" a formato ISO reconocible\n  const iso = s.trim().replace(' ', 'T') + 'Z';\n  const d = new Date(iso);\n  return isNaN(d.getTime()) ? null : d;\n}\n\nconst now = new Date(); // Fecha actual\nconst pendientes = [];\n\nfor (const item of items) {\n  const row = item.json;\n  const estado = String(row.estado || '').trim().toUpperCase();\n  const runAt = parseNextRunToDateUTC(row.next_run);\n\n  // Solo procesar si está ACTIVA y tiene fecha válida\n  if (estado === 'ACTIVA' && runAt && now >= runAt) {\n    pendientes.push({\n      json: {\n        Email: row.Email || row.email || '',\n        Modalidad: row.Modalidad || '',\n        Region: row.Region || row['Región'] || '',\n        Frecuencia: row.Frecuencia || '',\n        next_run: row.next_run,\n        estado: row.estado,\n      }\n    });\n  }\n}\n\n// Devolver solo usuarios pendientes\nreturn pendientes;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        -128
      ],
      "id": "19ad77d8-e05d-4b5d-a4b6-14adda1bda53",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Santiago",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "21adf823-ffa4-4e77-8593-d0a0b0631499",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9763efdd3422bc3e20d11e17904c1ed5ca787a59ab663c85047a13456c18dc45"
  },
  "id": "PUY26b5QuwlX2Uob",
  "tags": []
}