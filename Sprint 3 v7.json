{
  "name": "Sprint 3 v7",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// === Helpers ===\n\n// Normaliza texto: sin tildes, min√∫sculas, sin espacios extra\nfunction norm(s){\n  return String(s || '')\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') // sin acentos\n    .toLowerCase()\n    .trim();\n}\n\n// Fecha actual en horario de Chile\nconst nowChile = new Date(\n  new Date().toLocaleString('en-US', { timeZone: 'America/Santiago' })\n);\n\n// Formato local: yyyy-MM-dd HH:mm:ss (compatible con tu Filtrar por next_run)\nfunction formatLocal(dt){\n  const pad = n => String(n).padStart(2,'0');\n  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ` +\n         `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;\n}\n\n// Calcula la pr√≥xima ejecuci√≥n seg√∫n la frecuencia del formulario\nfunction nextFrom(freq, base = nowChile){\n  const f = norm(freq);           // ej: \"4 dias\", \"15 dias\", \"cada semana\", \"cada mes\"\n  const d = new Date(base);\n\n  // Por si alg√∫n d√≠a usas frecuencia de 30 minutos\n  if (f.includes('30') && f.includes('min')) {\n    d.setMinutes(d.getMinutes() + 30);\n  }\n  // 4 d√≠as (\"4 d√≠as\")\n  else if (f.includes('4') && f.includes('dia')) {\n    d.setDate(d.getDate() + 4);\n  }\n  // 15 d√≠as / quincenal\n  else if ((f.includes('15') && f.includes('dia')) || f.includes('quincen')) {\n    d.setDate(d.getDate() + 15);\n  }\n  // semanal (\"Cada Semana\")\n  else if (f.includes('semana')) {\n    d.setDate(d.getDate() + 7);\n  }\n  // mensual (\"Cada Mes\" / \"30 d√≠as\")\n  else if (f.includes('mes') || f.includes('30')) {\n    d.setMonth(d.getMonth() + 1);\n  }\n  // diario gen√©rico\n  else if (f.includes('dia')) {\n    d.setDate(d.getDate() + 1);\n  }\n  // fallback ‚Üí semanal\n  else {\n    d.setDate(d.getDate() + 7);\n  }\n\n  return formatLocal(d);\n}\n\n// === L√≥gica del nodo ===\nconst data = items[0].json;\n\n// Puede venir como \"Frecuencia\" o como label largo del form\nconst freq = data.Frecuencia\n  || data['Elije la frecuencia con la cual deseas recibir ofertas:']\n  || '';\n\ndata.next_run = nextFrom(freq);\ndata.estado   = 'ACTIVA';\n\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        976
      ],
      "id": "cea38da7-0f83-436e-854e-45035a866fba",
      "name": "next_run1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2a7bb9ee-b99d-40d9-ac05-d05048a35194",
              "leftValue": "={{ $json['Email:'] }}",
              "rightValue": "ERROR",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1072,
        976
      ],
      "id": "b60672b5-9d42-4cff-beab-c2a6124dcdd6",
      "name": "Revisar Estado1"
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}",
        "subject": "Error en el registro",
        "html": "=<p>Hola üëã</p>\n<p><strong>Faltan datos en tu registro.</strong></p>\n<p>Por favor, completa todos los campos obligatorios y revisa que tu correo est√© correctamente escrito.</p>\n\n<p>Campos incompletos detectados:</p>\n<ul>\n  {{ $('Validar datos1').item.json.faltantes }}\n</ul>\n\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -848,
        720
      ],
      "id": "a4c26e43-2a79-4d41-b130-f9341a5489a2",
      "name": "Error email1",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cdb74758-b031-42bc-9457-3084c7822e10",
              "leftValue": "={{ $json.esNuevo }}",
              "rightValue": "=",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -320,
        976
      ],
      "id": "d71154c4-8831-451b-9ef6-a0bb89074c4c",
      "name": "If"
    },
    {
      "parameters": {
        "content": "HU8 - Activar/Pausar Reportes",
        "height": 80,
        "width": 304,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1552,
        3232
      ],
      "id": "8b67a57f-8b26-4ba0-bf76-6296e0608e80",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "path": "=",
        "formTitle": "HU8 - Activar / Pausar reportes",
        "formFields": {
          "values": [
            {
              "fieldLabel": "email",
              "fieldType": "email",
              "requiredField": true
            },
            {
              "fieldLabel": "Accion",
              "fieldType": "radio",
              "fieldOptions": {
                "values": [
                  {
                    "option": "Pausar reportes programados"
                  },
                  {
                    "option": "Reanudar reportes programados"
                  }
                ]
              },
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "id": "9e15c1a8-4491-4bb8-aa3e-f33b1aa18004",
      "name": "Formulario_HU8",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 1,
      "position": [
        -1536,
        3392
      ],
      "webhookId": "03183869-f6a0-4fc8-9e1a-673c016f6077",
      "notesInFlow": false
    },
    {
      "parameters": {
        "operation": "lookup",
        "sheetId": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
        "range": "Registro de Inscritos!A:Z",
        "lookupColumn": "Email",
        "lookupValue": "={{ $json.email }}",
        "options": {
          "returnAllMatches": true
        }
      },
      "id": "3d44fa5f-1d72-4b62-9081-c7c6fa2130ef",
      "name": "Buscar_Usuario_en_Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 2,
      "position": [
        -1040,
        3392
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.Email }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "e7f6e2ac-1f12-4573-9e88-8b0798322514",
      "name": "Existe_Usuario?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -784,
        3392
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "mensaje",
              "value": "No encontramos una suscripci√≥n asociada a este correo. Verifica que est√©s registrado en el sistema."
            },
            {
              "name": "detalle",
              "value": "HU8 - 404 SUSCRIPCI√ìN NO EXISTE"
            }
          ]
        },
        "options": {}
      },
      "id": "cc8a34c8-7222-42da-b0d4-67420836944c",
      "name": "Mensaje_NoExiste",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -624,
        3648
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $('Formulario_HU8').item.json.Accion }}",
              "value2": "Pausar reportes programados"
            }
          ]
        }
      },
      "id": "94a6aa0c-8610-4e63-8d22-26ee971a4420",
      "name": "Decidir_Accion_Pausar_o_Reanudar",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -592,
        3264
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.estado }}",
              "value2": "PAUSADA"
            }
          ]
        }
      },
      "id": "acb932c6-c64f-42f2-afab-f3ea25636db2",
      "name": "Ya_Esta_Pausada?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -272,
        3168
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "mensaje",
              "value": "Tu suscripci√≥n ya se encuentra PAUSADA. No se realizaron cambios."
            },
            {
              "name": "detalle",
              "value": "HU8 - 400 SOLICITUD REDUNDANTE (PAUSAR)"
            }
          ]
        },
        "options": {}
      },
      "id": "1e376348-ad8e-4d6a-b60d-6bb52ca88140",
      "name": "Mensaje_YaPausada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -16,
        3120
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.estado }}",
              "value2": "ACTIVA"
            }
          ]
        }
      },
      "id": "8dd58d06-2c91-404b-a7dd-510caea61b75",
      "name": "Ya_Esta_Activa?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -288,
        3488
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "mensaje",
              "value": "Tu suscripci√≥n ya se encuentra ACTIVA. No se realizaron cambios."
            },
            {
              "name": "detalle",
              "value": "HU8 - 400 SOLICITUD REDUNDANTE (REANUDAR)"
            }
          ]
        },
        "options": {}
      },
      "id": "39acbc70-2f21-4a96-a089-2250746d24b9",
      "name": "Mensaje_YaActiva",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        0,
        3488
      ]
    },
    {
      "parameters": {
        "jsCode": "// Frecuencia del usuario (viene desde el lookup)\nconst freq = $('Buscar_Usuario_en_Sheet').first().json.Frecuencia || $json.frecuencia || null;\n\n// Fecha actual en horario Chile\nconst now = new Date(new Date().toLocaleString(\"en-US\", { timeZone: \"America/Santiago\" }));\n\n// Funci√≥n para calcular next_run seg√∫n frecuencia real\nfunction calcularNextRun(frecuencia) {\n  const fecha = new Date(now);\n\n  if (!frecuencia) {\n    // Si no viene frecuencia, por defecto 4 d√≠as\n    fecha.setDate(fecha.getDate() + 4);\n    return fecha.toISOString();\n  }\n\n  const f = frecuencia.toLowerCase().trim();\n\n  if (f.includes(\"d√≠a\") || f.includes(\"diaria\")) {\n    fecha.setDate(fecha.getDate() + 1);\n  }\n\n  else if (f.includes(\"4\")) {\n    fecha.setDate(fecha.getDate() + 4);\n  }\n\n  else if (f.includes(\"semana\")) {\n    fecha.setDate(fecha.getDate() + 7);\n  }\n\n  else if (f.includes(\"quincenal\") || f.includes(\"15\")) {\n    fecha.setDate(fecha.getDate() + 15);\n  }\n\n  else if (f.includes(\"mes\") || f.includes(\"30\")) {\n    fecha.setMonth(fecha.getMonth() + 1);\n  }\n\n  else {\n    // Fallback: 4 d√≠as\n    fecha.setDate(fecha.getDate() + 4);\n  }\n\n  return fecha.toISOString();\n}\n\n// Calcular next_run real\nconst nextRun = calcularNextRun(freq);\n\nreturn [{\n  email: $input.first().json.Email || $json.email,\n  accion: \"REANUDAR\",\n  estado_nuevo: \"ACTIVA\",\n  estado_anterior:$('Buscar_Usuario_en_Sheet').first().json.estado,\n  frecuencia: freq,\n  next_run: nextRun\n}];\n"
      },
      "id": "bfda0651-3f05-464f-810c-6d4f7ef221ad",
      "name": "Calcular_NextRun_Reanudar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -96,
        3728
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "resultado",
              "value": "Cambio de estado procesado correctamente."
            },
            {
              "name": "nota",
              "value": "Si pausaste, no recibir√°s reportes programados, pero los on-demand seguir√°n funcionando."
            }
          ]
        },
        "options": {}
      },
      "id": "1400d8ae-384f-4c99-95c6-f5311b217928",
      "name": "Mensaje_Final_HU8",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        704,
        3504
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Email": "={{ $json.Email }}",
            "estado": "PAUSADA"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Apellido",
              "displayName": "Apellido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frecuencia",
              "displayName": "Frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Modalidad",
              "displayName": "Modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Regi√≥n",
              "displayName": "Regi√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_update",
              "displayName": "last_update",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -16,
        3296
      ],
      "id": "ddb98f19-d47d-4d41-a395-7eb3af8c285e",
      "name": "Update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  email:  $('Formulario_HU8').first().json.email|| $json.Email,\n  accion:$('Formulario_HU8').first().json.Accion || $node.Form_HU8.json.accion,\n  estado_anterior: $('Buscar_Usuario_en_Sheet').first().json.estado,\n  estado_nuevo: $json.estado_nuevo || $json.estado || ($('Formulario_HU8').first().json.Accion === \"Pausar reportes progranados\" ? \"PAUSADA\" : \"ACTIVA\"),\n  frecuencia: $('Buscar_Usuario_en_Sheet').first().json.Frecuencia || $node.Buscar_Usuario.json.frecuencia,\n  next_run: $('Buscar_Usuario_en_Sheet').first().json.next_run|| \"SIN_CAMBIO\",\n  timestamp: new Date().toLocaleString(\"es-CL\", { timeZone: \"America/Santiago\" }),\n  hu: \"HU8\",\n  ip: \"N/A\"\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        3360
      ],
      "id": "00bab346-3a1b-42da-b62f-4e1ad49cf986",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Email": "={{ $json.email }}",
            "estado": "ACTIVA"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Apellido",
              "displayName": "Apellido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frecuencia",
              "displayName": "Frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Modalidad",
              "displayName": "Modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Regi√≥n",
              "displayName": "Regi√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        80,
        3728
      ],
      "id": "01bc8085-994d-4828-b525-54b806d2855e",
      "name": "Update row in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  email:  $('Formulario_HU8').first().json.email|| $json.Email,\n  accion:$('Formulario_HU8').first().json.Accion || $node.Form_HU8.json.accion,\n  estado_anterior: $('Buscar_Usuario_en_Sheet').first().json.estado,\n  estado_nuevo: $json.estado_nuevo || $json.estado || ($('Formulario_HU8').first().json.Accion === \"Pausar reportes progranados\" ? \"PAUSADA\" : \"ACTIVA\"),\n  frecuencia: $('Buscar_Usuario_en_Sheet').first().json.Frecuencia || $node.Buscar_Usuario.json.frecuencia,\n  next_run: $('Buscar_Usuario_en_Sheet').first().json.next_run|| \"SIN_CAMBIO\",\n  timestamp: new Date().toLocaleString(\"es-CL\", { timeZone: \"America/Santiago\" }),\n  hu: \"HU8\",\n  ip: \"N/A\"\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        3728
      ],
      "id": "b5048216-9c4d-4b81-b2a2-6f19d8a8fd8f",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "content": "HU1 -Registro y HU2 -  Actualizar Preferencias\n",
        "height": 80,
        "width": 256,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1232,
        800
      ],
      "id": "7fadb8b4-16ce-4f0c-963e-18a8217486cf",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "path": "ver-historial",
        "formTitle": "Consulta de Historial de Reportes",
        "formDescription": "Ingresa tu correo para ver todas las fechas donde recibiste reportes.",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Email",
              "fieldType": "email",
              "requiredField": true
            },
            {
              "fieldLabel": "Desde",
              "fieldType": "date"
            },
            {
              "fieldLabel": "Hasta",
              "fieldType": "date"
            }
          ]
        },
        "options": {
          "formSubmittedText": "Your response has been recorded"
        }
      },
      "id": "a648284b-c6f2-4981-9aa8-f9e26998ead3",
      "name": "HU7 - Form Trigger",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 1,
      "position": [
        1712,
        1280
      ],
      "webhookId": "de4914be-b14a-4b5e-9b57-893a08ffa78d"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 51153146,
          "mode": "list",
          "cachedResultName": "CantReporte",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=51153146"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{ $json.Email }}"
            }
          ]
        },
        "options": {
          "returnAllMatches": "returnAllMatches"
        }
      },
      "id": "dfc11439-547e-4bae-9374-b52415713c9a",
      "name": "HU7 - Obtener Historial",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        2720,
        1264
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = items.map(i => i.json);\n\n// Obtener fechas del formulario\nconst desde = new Date($('HU7 - Form Trigger').first().json.desde);\nconst hasta = new Date($('HU7 - Form Trigger').first().json.hasta);\n\n// Filtrado por rango\nlet resultados = rows.filter(r => {\n  if (!r.timestamp) return false;\n  const t = new Date(r.timestamp);\n  return t >= desde && t <= hasta;\n});\n\n// ORDENAR resultados por fecha ASCENDENTE (del m√°s antiguo al m√°s reciente)\nresultados.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n\nlet tabla = \"\";\n\nif (resultados.length === 0) {\n  tabla = `<p style=\"color:#555;\">No se encontraron registros en el rango seleccionado.</p>`;\n} else {\n  tabla = `\n    <table style=\"width:100%; border-collapse: collapse; margin-top: 10px;\">\n      <thead>\n        <tr style=\"background:#f0f0f0; text-align:left;\">\n          <th style=\"padding:8px; border-bottom:1px solid #ccc;\">Fecha</th>\n          <th style=\"padding:8px; border-bottom:1px solid #ccc;\">Tipo</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${\n          resultados.map(r => `\n            <tr>\n              <td style=\"padding:8px; border-bottom:1px solid #eee;\">${r.timestamp}</td>\n              <td style=\"padding:8px; border-bottom:1px solid #eee;\">${r.tipo}</td>\n            </tr>\n          `).join(\"\")\n        }\n      </tbody>\n    </table>\n  `;\n}\n\nconst cuerpo = `\n  <div style=\"font-family:Arial, sans-serif; line-height:1.5; color:#333;\">\n    <h2 style=\"color:#2d6cdf;\">Historial de Reportes</h2>\n    <p>Hola,</p>\n\n    <p>Aqu√≠ tienes el listado de tus reportes enviados dentro del rango seleccionado:</p>\n\n    <p><b>Rango aplicado:</b><br>\n    Desde: ${$('HU7 - Form Trigger').first().json.desde}<br>\n    Hasta: ${$('HU7 - Form Trigger').first().json.hasta}</p>\n\n    ${tabla}\n\n    <br>\n    <p>Saludos,<br>\n    <strong>Agente de Reportes Automatizados</strong></p>\n  </div>\n`;\n\nreturn [{ json: { cuerpo } }];\n"
      },
      "id": "9f0956ae-c6d1-4c3b-ba42-cb27ac89889c",
      "name": "HU7 - Formatear Respuesta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        1264
      ]
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('HU7 - Form Trigger').first().json.Email }}",
        "subject": "Historial de Reportes",
        "text": "=",
        "html": "={{$json.cuerpo}}",
        "options": {}
      },
      "id": "1c7fda93-b9d2-44f8-b151-755277b1c77d",
      "name": "HU7 - Enviar Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        3120,
        1264
      ],
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "content": "HU7 - Visualizar Reportes\n",
        "height": 80,
        "width": 262
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1760,
        1120
      ],
      "id": "de8e1a3b-df62-4d6c-85d9-12d79466a8a9",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.Email }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "178b6a6c-f1a2-4682-82d7-d4a5513656fa",
      "name": "Existe_Usuario?2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2464,
        1280
      ]
    },
    {
      "parameters": {
        "operation": "lookup",
        "sheetId": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
        "range": "Registro de Inscritos!A:Z",
        "lookupColumn": "Email",
        "lookupValue": "={{ $json.Email }}",
        "options": {
          "returnAllMatches": true
        }
      },
      "id": "123c12f7-94b3-4da5-bcee-03f648fb34c7",
      "name": "Buscar_Usuario_en_Sheet2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 2,
      "position": [
        2256,
        1280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Formulario_HU8').item.json.email }}",
        "subject": "Error en el registro",
        "html": "=<p>Hola üëã</p>\n<p><strong>No encontramos una suscripci√≥n asociada a tu correo.</strong></p>\n\n<p>\nHemos recibido tu solicitud para activar/pausar reportes, pero en el sistema no aparece ning√∫n registro activo con el correo:\n</p>\n  {{ $('Formulario_HU8').item.json.email }}\n<p style=\"font-size: 16px; font-weight: bold; margin: 8px 0;\">\n  \n</p>\n\n<p>\nEsto puede deberse a que:\n</p>\n<ul>\n  <li>A√∫n no te has suscrito al servicio de reportes autom√°ticos.</li>\n  <li>Ingresaste el correo con alg√∫n error de escritura.</li>\n</ul>\n\n<p>\nPor favor, verifica que tu correo est√© correctamente escrito o completa primero el formulario de suscripci√≥n antes de solicitar un reporte inmediato.\n</p>\n\n<p>\nSi crees que se trata de un error, puedes responder a este correo indicando el correo correcto o contactarte con el equipo a trav√©s de los canales habituales.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -432,
        3648
      ],
      "id": "a667408c-4889-4e88-8775-01804c0bc879",
      "name": "No existe email1",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtMinute": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        768,
        800
      ],
      "id": "c456a97e-adf1-4ef3-b740-0acfa9a404ca",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Este nodo recibe 1 item del Schedule Trigger\n// Si NO es d√≠a 1, corta el flujo.\n// Si es d√≠a 1, deja pasar el item.\n\nconst now = new Date();\nconst dia = now.getDate();\n\nif (dia !== 1) {\n  // No es cambio de mes ‚Üí no hacemos nada\n  return [];\n}\n\n// Es d√≠a 1 ‚Üí seguimos\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        800
      ],
      "id": "4cb35d25-4766-4adf-bab6-0d77e1d24dec",
      "name": "Code in JavaScript7",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1184,
        800
      ],
      "id": "5f92a404-32e2-4253-b366-813b5572419e",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Este nodo toma todas las filas de LimitesReportes\n// y prepara una salida con usados = 0, mes = mes actual,\n// actualizado_ts = ahora.\n\nfunction pad(n) {\n  return String(n).padStart(2, '0');\n}\n\nfunction formatTs(d) {\n  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ` +\n         `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\n}\n\nconst now = new Date();\nconst mesActual = `${now.getFullYear()}-${pad(now.getMonth()+1)}`; // YYYY-MM\nconst ts = formatTs(now);\n\nreturn items.map(item => {\n  const row = item.json;\n\n  return {\n    json: {\n      // clave para hacer match\n      email: row.email,\n\n      // mantenemos el mismo l√≠mite\n      limite: row.limite,\n\n      // reinicio de contador mensual\n      usados: 0,\n\n      // mes del reinicio\n      mes: mesActual,\n\n      // fecha del √∫ltimo reinicio / actualizaci√≥n\n      actualizado_ts: ts,\n\n      // preservamos key si te sirve, o la dejamos vac√≠a\n      key: row.key || ''\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        800
      ],
      "id": "648f629d-e24c-4528-a115-edea92967a10",
      "name": "Code in JavaScript8"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{$json.email}}",
            "usados": "0",
            "mes": "={{ $now.toFormat(\"yyyy-LL\") }}",
            "actualizado_ts": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "limite",
              "displayName": "limite",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "usados",
              "displayName": "usados",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes",
              "displayName": "mes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "actualizado_ts",
              "displayName": "actualizado_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "key",
              "displayName": "key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1600,
        800
      ],
      "id": "6f107ccb-1016-40ce-b9c6-548759aba012",
      "name": "Update row in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "content": "Flujo de reinicio Limite Mensual",
        "height": 80,
        "width": 224,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        784,
        640
      ],
      "id": "c0967bb3-37e1-4ecc-b906-2b16f26046f4",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('HU7 - Form Trigger').item.json.Email }}",
        "subject": "Error en el registro",
        "html": "=<p>Hola üëã</p>\n<p><strong>No encontramos un historial de reportes asociado a tu correo.</strong></p>\n\n<p>\nHemos recibido tu solicitud para visualizar tus reportes, pero en el sistema no aparece ning√∫n registro con el correo:\n</p>\n\n<p style=\"font-size: 16px; font-weight: bold; margin: 8px 0;\">\n  {{ $('HU7 - Form Trigger').item.json.Email }}\n</p>\n\n<p>\nEsto puede deberse a que:\n</p>\n<ul>\n  <li>A√∫n no te has suscrito al servicio de reportes autom√°ticos.</li>\n  <li>Todav√≠a no se ha generado ning√∫n reporte con este correo.</li>\n  <li>Ingresaste el correo con alg√∫n error de escritura.</li>\n</ul>\n\n<p>\nPor favor, verifica que tu correo est√© correctamente escrito o completa primero el formulario de suscripci√≥n para comenzar a recibir reportes.\n</p>\n\n<p>\nSi crees que se trata de un error, puedes responder a este correo indicando el correo correcto o contactarte con el equipo a trav√©s de los canales habituales.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        2736,
        1504
      ],
      "id": "090b8387-b72b-424f-9df3-488491204a1f",
      "name": "No existe email HU7",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Nodo: \"HUx - Sanitizar Input\"\n// Este Code va inmediatamente DESPU√âS del Form Trigger de cada HU.\n\n// üîπ Configura ac√° qu√© campos son obligatorios en ESTE formulario\nconst requiredFields = ['$json.email']; // Ej: para HU7 solo Email\n\n// üîπ Listas de valores permitidos\nconst allowedFrecuencia = ['inmediato', 'diario', 'semanal', 'mensual'];\nconst allowedModalidad  = ['remoto', 'presencial', 'hibrido', 'h√≠brido'];\nconst allowedUbicacion  = [\n  'valparaiso',\n  'vi√±a del mar',\n  'quilpue',\n  'villa alemana',\n  'santiago',\n  // agrega las que uses en el form\n];\n\nfunction normStr(v) {\n  if (v === undefined || v === null) return '';\n  return String(v).trim();\n}\n\nfunction isValidEmail(email) {\n  const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return re.test(email);\n}\n\nfunction isValidDateYMD(v) {\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\n  const [y, m, d] = v.split('-').map(Number);\n  const dt = new Date(y, m - 1, d);\n  return (\n    dt.getFullYear() === y &&\n    dt.getMonth() === m - 1 &&\n    dt.getDate() === d\n  );\n}\n\nreturn items.map(item => {\n  const src = item.json || {};\n  const data = {};\n  const errores = [];\n\n  // 1) Copiar y hacer trim de todos los strings\n  for (const [k, v] of Object.entries(src)) {\n    data[k] = typeof v === 'string' ? normStr(v) : v;\n  }\n\n  // 2) Campos obligatorios\n  for (const field of requiredFields) {\n    if (!data[field] || data[field] === '') {\n      errores.push(`Campo obligatorio faltante: ${field}`);\n    }\n  }\n\n  // 3) Normalizar y validar emails (cualquier campo que tenga \"email\" en el nombre)\n  for (const [k, v] of Object.entries(data)) {\n    if (k.toLowerCase().includes('email')) {\n      const em = normStr(v).toLowerCase();\n      if (em === '' || !isValidEmail(em)) {\n        errores.push(`Email inv√°lido en campo \"${k}\": \"${v}\"`);\n      }\n      data[k] = em;\n    }\n  }\n\n  // 4) Validar fechas en formato AAAA-MM-DD\n  for (const [k, v] of Object.entries(data)) {\n    if (typeof v === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(v)) {\n      if (!isValidDateYMD(v)) {\n        errores.push(`Fecha inv√°lida en campo \"${k}\": \"${v}\"`);\n      }\n    }\n  }\n\n  // 5) Validar frecuencia, modalidad, ubicaci√≥n si existen\n  if (data.frecuencia) {\n    const f = normStr(data.frecuencia).toLowerCase();\n    if (!allowedFrecuencia.includes(f)) {\n      errores.push(`Frecuencia no permitida: \"${data.frecuencia}\"`);\n    }\n    data.frecuencia = f;\n  }\n\n  if (data.modalidad) {\n    const m = normStr(data.modalidad).toLowerCase();\n    if (!allowedModalidad.includes(m)) {\n      errores.push(`Modalidad no permitida: \"${data.modalidad}\"`);\n    }\n    data.modalidad = m;\n  }\n\n  if (data.ubicacion) {\n    const u = normStr(data.ubicacion).toLowerCase();\n    if (!allowedUbicacion.includes(u)) {\n      errores.push(`Ubicaci√≥n no permitida: \"${data.ubicacion}\"`);\n    }\n    data.ubicacion = u;\n  }\n\n  // 6) Marcar si pas√≥ o no la validaci√≥n\n  data._ok = errores.length === 0;\n  data._errores = errores;\n\n  return { json: data };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        1280
      ],
      "id": "bd09a26b-2a30-4087-bf38-8a3bd5983c97",
      "name": "Sanitizar"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: \"HUx - Sanitizar Input\"\n// Este Code va inmediatamente DESPU√âS del Form Trigger de cada HU.\n\n// üîπ Configura ac√° qu√© campos son obligatorios en ESTE formulario\nconst requiredFields = ['$json.email']; // Ej: para HU7 solo Email\n\n// üîπ Listas de valores permitidos\nconst allowedFrecuencia = ['inmediato', 'diario', 'semanal', 'mensual'];\nconst allowedModalidad  = ['remoto', 'presencial', 'hibrido', 'h√≠brido'];\nconst allowedUbicacion  = [\n  'valparaiso',\n  'vi√±a del mar',\n  'quilpue',\n  'villa alemana',\n  'santiago',\n  // agrega las que uses en el form\n];\n\nfunction normStr(v) {\n  if (v === undefined || v === null) return '';\n  return String(v).trim();\n}\n\nfunction isValidEmail(email) {\n  const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return re.test(email);\n}\n\nfunction isValidDateYMD(v) {\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\n  const [y, m, d] = v.split('-').map(Number);\n  const dt = new Date(y, m - 1, d);\n  return (\n    dt.getFullYear() === y &&\n    dt.getMonth() === m - 1 &&\n    dt.getDate() === d\n  );\n}\n\nreturn items.map(item => {\n  const src = item.json || {};\n  const data = {};\n  const errores = [];\n\n  // 1) Copiar y hacer trim de todos los strings\n  for (const [k, v] of Object.entries(src)) {\n    data[k] = typeof v === 'string' ? normStr(v) : v;\n  }\n\n  // 2) Campos obligatorios\n  for (const field of requiredFields) {\n    if (!data[field] || data[field] === '') {\n      errores.push(`Campo obligatorio faltante: ${field}`);\n    }\n  }\n\n  // 3) Normalizar y validar emails (cualquier campo que tenga \"email\" en el nombre)\n  for (const [k, v] of Object.entries(data)) {\n    if (k.toLowerCase().includes('email')) {\n      const em = normStr(v).toLowerCase();\n      if (em === '' || !isValidEmail(em)) {\n        errores.push(`Email inv√°lido en campo \"${k}\": \"${v}\"`);\n      }\n      data[k] = em;\n    }\n  }\n\n  // 4) Validar fechas en formato AAAA-MM-DD\n  for (const [k, v] of Object.entries(data)) {\n    if (typeof v === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(v)) {\n      if (!isValidDateYMD(v)) {\n        errores.push(`Fecha inv√°lida en campo \"${k}\": \"${v}\"`);\n      }\n    }\n  }\n\n  // 5) Validar frecuencia, modalidad, ubicaci√≥n si existen\n  if (data.frecuencia) {\n    const f = normStr(data.frecuencia).toLowerCase();\n    if (!allowedFrecuencia.includes(f)) {\n      errores.push(`Frecuencia no permitida: \"${data.frecuencia}\"`);\n    }\n    data.frecuencia = f;\n  }\n\n  if (data.modalidad) {\n    const m = normStr(data.modalidad).toLowerCase();\n    if (!allowedModalidad.includes(m)) {\n      errores.push(`Modalidad no permitida: \"${data.modalidad}\"`);\n    }\n    data.modalidad = m;\n  }\n\n  if (data.ubicacion) {\n    const u = normStr(data.ubicacion).toLowerCase();\n    if (!allowedUbicacion.includes(u)) {\n      errores.push(`Ubicaci√≥n no permitida: \"${data.ubicacion}\"`);\n    }\n    data.ubicacion = u;\n  }\n\n  // 6) Marcar si pas√≥ o no la validaci√≥n\n  data._ok = errores.length === 0;\n  data._errores = errores;\n\n  return { json: data };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        3392
      ],
      "id": "124d8e81-8f0a-41d0-a64c-4e21be59cda0",
      "name": "Sanitizar2"
    },
    {
      "parameters": {
        "jsCode": "// VALIDAR Y SANITIZAR FORM PRINCIPAL (On form submission2)\n\n// Helpers\nfunction cleanText(value) {\n  return String(value ?? \"\").trim();\n}\n\nfunction toTitleCase(value) {\n  const v = cleanText(value).toLowerCase();\n  if (!v) return \"\";\n  return v\n    .split(/\\s+/)\n    .map(w => w.charAt(0).toUpperCase() + w.slice(1))\n    .join(\" \");\n}\n\nfunction isValidEmail(email) {\n  const v = cleanText(email).toLowerCase();\n  if (!v) return false;\n  const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return re.test(v);\n}\n\n// Listas permitidas (tomadas del propio formulario)\nconst allowedFrecuencia = [\n  \"4 D√≠as\",\n  \"15 D√≠as\",\n  \"Cada Semana\",\n  \"Cada Mes\"\n];\n\nconst allowedModalidad = [\n  \"Remota\",\n  \"Presencial\",\n  \"H√≠brido\"\n];\n\nconst allowedRegion = [\n  \"Arica y Parinacota\",\n  \"Tarapac√°\",\n  \"Antofagasta\",\n  \"Atacama\",\n  \"Coquimbo\",\n  \"Valpara√≠so\",\n  \"Regi√≥n del Libertador Gral. Bernardo O‚ÄôHiggins\",\n  \"Regi√≥n del Maule\",\n  \"Regi√≥n del √ëuble\",\n  \"Regi√≥n del Biob√≠o\",\n  \"Regi√≥n de La Araucan√≠a\",\n  \"Regi√≥n de Los R√≠os\",\n  \"Regi√≥n de Los Lagos\",\n  \"Regi√≥n Ais√©n del Gral. Carlos Ib√°√±ez del Campo\",\n  \"Regi√≥n de Magallanes y de la Ant√°rtica Chilena\",\n  \"Regi√≥n Metropolitana de Santiago\"\n];\n\nconst input = $json;\n\n// 1) Leer y sanitizar b√°sicos\nconst nombreRaw =$input.first().json['Nombre:'];\nconst apellidoRaw = $input.first().json['Apellido:'];\nconst emailRaw = $input.first().json['Email:'];\n\nconst nombre = toTitleCase(nombreRaw);\nconst apellido = toTitleCase(apellidoRaw);\nconst email = cleanText(emailRaw).toLowerCase();\n\n// 2) Leer selecci√≥n de frecuencia / modalidad / regi√≥n\nconst freqLabel = \"Elije la frecuencia con la cual deseas recibir ofertas:\";\nconst regionLabel = \"Elije la Regi√≥n en la cual te gustar√≠a centrar tu busqueda:\";\n\nlet frecuencia = cleanText(input.Frecuencia ?? input[freqLabel]);\nlet modalidad = cleanText(input[\"Modalidad:\"]);\nlet region    = cleanText(input[\"Regi√≥n\"] ?? input[regionLabel]); // por si en alg√∫n momento cambia el label\n\n\n// 7) Si todo OK ‚Üí devolvemos datos sanitizados y estado OK\nreturn [\n  {\n    json: {\n      ...input,\n      // sobrescribimos con valores limpios\n      \"Nombre:\": nombre,\n      \"Apellido:\": apellido,\n      \"Email:\": email,\n      // duplicamos por si alg√∫n nodo usa estas claves \"cortas\"\n      Frecuencia: frecuencia,\n      Modalidad: modalidad,\n      Regi√≥n: region,\n      estado: \"ACTIVA\"\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        976
      ],
      "id": "e0dcf684-1776-4447-9a56-a24afb10eee6",
      "name": "Validar datos1"
    },
    {
      "parameters": {
        "formTitle": "Sistema automatizado para la b√∫squeda de pr√°cticas profesionales en Inform√°tica",
        "formDescription": " Este proyecto tiene como objetivo desarrollar un sistema automatizado que facilite la b√∫squeda y gesti√≥n de pr√°cticas profesionales en el √°rea de Inform√°tica. La soluci√≥n permite conectar de manera eficiente a estudiantes con empresas que ofrecen oportunidades de pr√°ctica, optimizando el proceso mediante el uso de tecnolog√≠a y algoritmos de filtrado inteligente.  ",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Nombre:",
              "requiredField": true
            },
            {
              "fieldLabel": "Apellido:",
              "requiredField": true
            },
            {
              "fieldLabel": "Email:",
              "fieldType": "email",
              "requiredField": true
            },
            {
              "fieldLabel": "Elije la frecuencia con la cual deseas recibir ofertas:",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "4 D√≠as"
                  },
                  {
                    "option": "15 D√≠as"
                  },
                  {
                    "option": "Cada Semana"
                  },
                  {
                    "option": "Cada Mes"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "Modalidad:",
              "fieldType": "radio",
              "fieldOptions": {
                "values": [
                  {
                    "option": "Remota"
                  },
                  {
                    "option": "Presencial"
                  },
                  {
                    "option": "H√≠brido"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "Elije la Regi√≥n en la cual te gustar√≠a centrar tu busqueda:",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "Regi√≥n de Arica y Parinacota"
                  },
                  {
                    "option": "Regi√≥n de Tarapac√°"
                  },
                  {
                    "option": "Regi√≥n de Antofagasta"
                  },
                  {
                    "option": "Regi√≥n de Atacama"
                  },
                  {
                    "option": "Regi√≥n de Coquimbo"
                  },
                  {
                    "option": "Regi√≥n de Valpara√≠so"
                  },
                  {
                    "option": "Regi√≥n Metropolitana de Santiago "
                  },
                  {
                    "option": "Regi√≥n del Libertador General Bernardo O‚ÄôHiggins"
                  },
                  {
                    "option": "Regi√≥n del Maule "
                  },
                  {
                    "option": "Regi√≥n de √ëuble "
                  },
                  {
                    "option": "Regi√≥n del Biob√≠o"
                  },
                  {
                    "option": "Regi√≥n de La Araucan√≠a "
                  },
                  {
                    "option": "Regi√≥n de Los R√≠os"
                  },
                  {
                    "option": "Regi√≥n de Los Lagos "
                  },
                  {
                    "option": "Regi√≥n de Ays√©n del General Carlos Ib√°√±ez del Campo "
                  },
                  {
                    "option": "Regi√≥n de Magallanes y de la Ant√°rtica Chilena "
                  }
                ]
              },
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.3,
      "position": [
        -1504,
        976
      ],
      "id": "36e6b0a7-62be-4137-b6d1-01c1267d5ffc",
      "name": "Form de registro y Cambio de preferencias",
      "webhookId": "65e8f343-cd85-423c-a79c-0d9c0a11d4fa",
      "alwaysOutputData": true,
      "executeOnce": false,
      "retryOnFail": true
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?pli=1&gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -704,
        976
      ],
      "id": "65dffb84-0838-4572-8923-ee518a86103b",
      "name": "HU2 - Verificar existencia",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "=https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Nombre": "= {{ $('Form de registro y Cambio de preferencias').item.json['Nombre:'] }}",
            "Frecuencia": "={{ $('Form de registro y Cambio de preferencias').item.json['Elije la frecuencia con la cual deseas recibir ofertas:'] }}",
            "estado": "={{ $('Revisar Estado1').item.json.estado }}",
            "next_run": "={{ $('next_run1').item.json.next_run }}\n",
            "Apellido": "={{ $('Form de registro y Cambio de preferencias').item.json['Apellido:'] }}",
            "Email": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}",
            "Modalidad": "={{ $('Form de registro y Cambio de preferencias').item.json['Modalidad:'] }}",
            "Regi√≥n": "={{ $('Form de registro y Cambio de preferencias').item.json['Elije la Regi√≥n en la cual te gustar√≠a centrar tu busqueda:'] }}",
            "row_number": 0,
            "last_update": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Apellido",
              "displayName": "Apellido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frecuencia",
              "displayName": "Frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Modalidad",
              "displayName": "Modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Regi√≥n",
              "displayName": "Regi√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "R_Programados",
              "displayName": "R_Programados",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "R_Inmediatos",
              "displayName": "R_Inmediatos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_update",
              "displayName": "last_update",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -96,
        1072
      ],
      "id": "6aae8598-8d44-4c32-ac42-2f2f894d834f",
      "name": "HU2 - Actualizar Pref.",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}",
        "subject": "¬°Ya estas registrado!",
        "html": "=<p>üëã Hola <strong>{{ $('Validar datos1').item.json['Nombre:'] }}</strong>,</p>\n\n<p>Tu registro ya exist√≠a en nuestro sistema y tus preferencias fueron <strong>actualizadas correctamente</strong> ‚úÖ</p>\n\n<p>üìå <strong>Nueva configuraci√≥n guardada:</strong></p>\n<ul>\n  <li>üì© <strong>Email:</strong> <em>{{ $('Validar datos1').item.json['Email:'] }}</em></li>\n  <li>‚è±Ô∏è <strong>Frecuencia de reportes:</strong> <em>{{ $('Validar datos1').item.json.Frecuencia }}</em></li>\n  <li>üíª <strong>Modalidad preferida:</strong> <em>{{ $('Validar datos1').item.json.Modalidad }}</em></li>\n  <li>üåç <strong>Regi√≥n de inter√©s:</strong> <em>{{ $('Validar datos1').item.json['Regi√≥n'] }}</em></li>\n</ul>\n\n<p>üéØ A partir de ahora, recibir√°s oportunidades de pr√°ctica ajustadas a estas preferencias.</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        112,
        1072
      ],
      "id": "e31750ce-396f-4fab-a016-2e24298f8fd7",
      "name": "HU2 - Email ya registrado1",
      "webhookId": "1f11458c-f8ff-438c-bd8f-3b3f3dcd37c1",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "=https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Nombre": "= {{ $('Form de registro y Cambio de preferencias').item.json['Nombre:'] }}",
            "Frecuencia": "={{ $('Form de registro y Cambio de preferencias').item.json['Elije la frecuencia con la cual deseas recibir ofertas:'] }}",
            "estado": "={{ $('Revisar Estado1').item.json.estado }}",
            "next_run": "= {{ $('next_run1').item.json.next_run }}",
            "Apellido": "={{ $('Form de registro y Cambio de preferencias').item.json['Apellido:'] }}",
            "Email": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}",
            "Modalidad": "={{ $('Form de registro y Cambio de preferencias').item.json['Modalidad:'] }}",
            "Regi√≥n": "={{ $('Form de registro y Cambio de preferencias').item.json['Elije la Regi√≥n en la cual te gustar√≠a centrar tu busqueda:'] }}",
            "last_update": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Apellido",
              "displayName": "Apellido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frecuencia",
              "displayName": "Frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Modalidad",
              "displayName": "Modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Regi√≥n",
              "displayName": "Regi√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_update",
              "displayName": "last_update",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -96,
        848
      ],
      "id": "164cb4bf-6128-46a6-84f4-7e382f9e6b18",
      "name": "HU1 - Agregar Usuario Nuevo",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}",
            "limite": "=5",
            "usados": "0",
            "mes": "={{ $now.toFormat('yyyy-LL') }}\n",
            "actualizado_ts": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "limite",
              "displayName": "limite",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "usados",
              "displayName": "usados",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes",
              "displayName": "mes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "actualizado_ts",
              "displayName": "actualizado_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "key",
              "displayName": "key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        80,
        848
      ],
      "id": "6f77c2a9-aef6-4af9-9fe0-9486fbd6e9fd",
      "name": "HU1 - Nuevo Limite Reporte",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}\n",
        "subject": "Confirmaci√≥n de registro",
        "html": "=<p>üëã Hola <strong>{{ $('Form de registro y Cambio de preferencias').item.json['Nombre:'] }} {{ $('Form de registro y Cambio de preferencias').item.json['Apellido:'] }}</strong>\n,</p>\n\n<p>Tu registro en el sistema automatizado de b√∫squeda de pr√°cticas profesionales en inform√°tica fue <strong>exitoso</strong>.</p>\n\n<p>üì© Has indicado el siguiente correo: <em>{{ $('Form de registro y Cambio de preferencias').item.json['Email:'] }}</em></p>\n\n<p>‚öôÔ∏è <strong>Preferencias registradas:</strong></p>\n<ul>\n  <li>‚è±Ô∏è Frecuencia de reportes: <em>{{ $('Form de registro y Cambio de preferencias').item.json['Elije la frecuencia con la cual deseas recibir ofertas:'] }}</em></li>\n  <li>üíª Modalidad preferida: <em>{{ $('Form de registro y Cambio de preferencias').item.json['Modalidad:'] }}</em></li>\n  <li>üåç Regi√≥n de inter√©s: <em>{{ $('Form de registro y Cambio de preferencias').item.json['Elije la Regi√≥n en la cual te gustar√≠a centrar tu busqueda:'] }}</em></li>\n</ul>\n\n<p>Gracias por registrarte üéâ</p>\n\n<p>\nA partir de ahora recibir√°s las oportunidades de pr√°ctica seleccionadas autom√°ticamente seg√∫n tus preferencias.<br>\nSi deseas modificar tus datos o cancelar tu suscripci√≥n, puedes hacerlo en cualquier momento respondiendo a este correo.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        288,
        848
      ],
      "id": "20cb838b-e5e7-49f8-867a-31c33fdbabed",
      "name": "HU1 - Email registro exitoso1",
      "webhookId": "0fc67036-4214-4c8e-9214-24f0a46d3728",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 338813501,
          "mode": "list",
          "cachedResultName": "CambiosPreferencias",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=338813501"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $('HU2 - Actualizar Pref.').item.json.Email }}",
            "modalidad": "={{ $('HU2 - Actualizar Pref.').item.json.Modalidad }}",
            "region": "={{ $('HU2 - Actualizar Pref.').item.json['Regi√≥n'] }}",
            "frecuencia": "={{ $('HU2 - Actualizar Pref.').item.json.Frecuencia }}",
            " fecha de actualizacion": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": " fecha de actualizacion",
              "displayName": " fecha de actualizacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "frecuencia",
              "displayName": "frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "modalidad",
              "displayName": "modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "region",
              "displayName": "region",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        304,
        1072
      ],
      "id": "39dbf47d-ce25-4494-9778-9cadff48d4ff",
      "name": "HU2 - RegistroCambioPreferencias",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 2090709522,
          "mode": "list",
          "cachedResultName": "SuscripcionLogs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=2090709522"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "accion": "={{ $json.accion }}",
            "estado_anterior": "={{ $json.estado_anterior }}",
            "estado_nuevo": "={{ $json.estado_nuevo }}",
            "frecuencia": "={{ $json.frecuencia }}",
            "email": "={{ $json.email }}"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "accion",
              "displayName": "accion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estado_anterior",
              "displayName": "estado_anterior",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estado_nuevo",
              "displayName": "estado_nuevo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "frecuencia",
              "displayName": "frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        528,
        3504
      ],
      "id": "6f581da8-1c01-4b4a-aacc-e4d883aa0ab4",
      "name": "Append row in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Este nodo toma el resultado de \"HU2 - Verificar existencia\"\n// y marca si el usuario es nuevo o ya existe en la hoja.\n\n// ¬øLa query devolvi√≥ alguna fila v√°lida?\nconst hasRow = items.length > 0\n  && items[0].json\n  && Object.keys(items[0].json).length > 0;\n\n// Si NO hay filas ‚Üí usuario nuevo\nif (!hasRow) {\n  return [{\n    json: {\n      esNuevo: true\n    }\n  }];\n}\n\n// Si hay al menos una fila ‚Üí usuario existente\nconst row = items[0].json;\n\nreturn [{\n  json: {\n    ...row,\n    esNuevo: false\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        976
      ],
      "id": "6f37ab98-dc05-4674-9b93-b0b08abb2c7c",
      "name": "Code in JavaScript9"
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $json.email_destino }}",
        "subject": "No se encontraron ofertas de pr√°ctica",
        "html": "=  <p>üëã Hola {{ $('Obtener Preferencias(HU4)').item.json.Nombre }},</p>\n\n<p>No se encontraron ofertas de pr√°ctica que coincidan con tus preferencias en esta ejecuci√≥n.</p>\n\n<p>Esto puede deberse a que:</p>\n<ul>\n  <li>No hubo publicaciones nuevas en las plataformas consultadas.</li>\n  <li>No existieron ofertas que coincidieran con tu regi√≥n o modalidad seleccionada.</li>\n  <li>Las fuentes revisadas (Indeed, Laborum, otras) no devolvieron resultados v√°lidos.</li>\n</ul>\n\n<p>El sistema seguir√° buscando autom√°ticamente seg√∫n tu frecuencia configurada.</p>\n\n<hr>\n<p style=\"font-size:12px;color:#888;\">\n  Sistema automatizado ‚Äì Buscador de Pr√°cticas de Inform√°tica<br>\n  No respondas a este correo.\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -4304,
        2192
      ],
      "id": "de17127f-4245-4afa-92ac-5f7b05ffbb39",
      "name": "Send email3",
      "webhookId": "7a8d1d54-0ce0-42b2-a5b8-9e16c9b1a570",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bf79c74d-9b01-4476-81be-de9447c4500b",
              "leftValue": "={{ $json.no_results_historial }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4608,
        2320
      ],
      "id": "6b67a64a-ad91-4ef8-b632-1c35dd773f31",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1496762465,
          "mode": "list",
          "cachedResultName": "HistorialOfertas",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=1496762465"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp_reporte": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}",
            "modalidad": "={{ $json.modalidad }}",
            "ubicacion": "={{ $json.region }}",
            "link": "={{ $json.link }}",
            "fuente ": "={{ $json.fuente }}",
            "titulo": "={{ $json.titulo }}",
            "empresa": "={{ $json.empresa }}",
            "Clave_unica": "={{ $json.titulo }} + {{ $json.empresa }}",
            "email": "={{ $('Sanitizar1').first().json.Email }}"
          },
          "matchingColumns": [
            "timestamp_reporte"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "timestamp_reporte",
              "displayName": "timestamp_reporte",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "fuente ",
              "displayName": "fuente ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "titulo",
              "displayName": "titulo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "empresa",
              "displayName": "empresa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ubicacion",
              "displayName": "ubicacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "modalidad",
              "displayName": "modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "link",
              "displayName": "link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Clave_unica",
              "displayName": "Clave_unica",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -4464,
        2512
      ],
      "id": "de9d12fe-3384-4b63-854c-b1127bed2ad5",
      "name": "HU3 - Historial Ofertas2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// === HU3 - PREPARAR HISTORIAL (Versi√≥n Robustecida HU4) ===\n\n// 1. Helpers\nfunction pad(n) { return String(n).padStart(2, '0'); }\n\nfunction formatTs(d) {\n  return (\n    d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + ' ' +\n    pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds())\n  );\n}\n\n// Funci√≥n 'pick' mejorada: devuelve el primer valor que no sea nulo ni vac√≠o\nfunction pick(...xs) {\n  for (const x of xs) {\n    if (x !== undefined && x !== null && String(x).trim() !== \"\") return x;\n  }\n  return \"\";\n}\n\nconst ahora = new Date();\nconst timestamp_reporte = formatTs(ahora);\n\n// 2. Obtener Email del Usuario (Desde HU4 - Sanitizar1)\nlet emailUsuario = 'desconocido@ejemplo.cl';\ntry {\n  // Intentamos leer el email que pas√≥ por el sanitizador\n  const u = $('Sanitizar1').first().json || {};\n  emailUsuario = u.Email || u.email || emailUsuario;\n} catch (e) {\n  console.log(\"No se pudo leer email de Sanitizar1, usando default.\");\n}\n\n// 3. Procesar Items\nconst out = [];\n\nfor (const item of $input.all()) {\n  const raw = item.json || {};\n  \n  // Normalizaci√≥n de datos anidados (por si acaso)\n  // Si raw tiene 'titulo' usamos raw, si no, intentamos raw.data\n  const d = (raw.titulo || raw.link || raw.fuente || raw['fuente ']) ? raw : (raw.data || raw);\n\n  // --- EXTRACCI√ìN ROBUSTA ---\n  // Aqu√≠ usamos la misma l√≥gica del Email Builder para no fallar\n  \n  const titulo = pick(d.titulo, d.Titulo, d.title, d.Title, d.nombre);\n  const link   = pick(d.link, d.Link, d.url, d.href);\n  \n  // ‚ùå Si no hay t√≠tulo o link ‚Üí NO se guarda\n  if (!titulo || !link) continue;\n\n  const empresa   = pick(d.empresa, d.Empresa, d.company, \"Sin empresa\");\n  const ubicacion = pick(d.region, d.Region, d.ubicacion, d.location, \"Sin regi√≥n\");\n  \n  // Fuente: Aqu√≠ corregimos el error del espacio y las may√∫sculas\n  const fuente = pick(d['fuente '], d.fuente, d.Fuente, d.source, \"Fuente Desconocida\");\n\n  // Modalidad: Normalizamos a min√∫sculas\n  let modalidad = pick(d.modalidad, d.Modalidad, \"No especificada\");\n  if (modalidad) modalidad = String(modalidad).toLowerCase();\n\n  const fecha_oferta = d.fecha_oferta || timestamp_reporte;\n\n  // Clave √∫nica para evitar duplicados futuros en otras l√≥gicas\n  const clave_unica = `${titulo}|${empresa}|${link}|${fuente}`;\n\n  out.push({\n    json: {\n      timestamp_reporte,\n      email_destino: emailUsuario, // Para que el Sheet sepa de qui√©n es\n      titulo,\n      empresa,\n      ubicacion, // Esto ir√° a la columna 'region' o 'ubicacion' del sheet\n      region: ubicacion, // Enviamos ambos por seguridad\n      modalidad,\n      fecha_oferta,\n      link,\n      fuente, // Ahora s√≠ llevar√° \"Computrabajo\" o \"Laborum\" correctamente\n      clave_unica,\n      no_results_historial: false,\n    },\n  });\n}\n\n// 4. Manejo de \"Sin Resultados\"\n// Si no sali√≥ nada v√°lido, enviamos un flag para que el IF siguiente decida qu√© hacer\nif (out.length === 0) {\n  return [{\n    json: {\n      no_results_historial: true,\n      email_destino: emailUsuario,\n      timestamp_reporte\n    }\n  }];\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4896,
        2384
      ],
      "id": "8a31372c-bac7-43d1-b4f7-6b9d10fda16e",
      "name": "HU3 - PrepararHistorial"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: \"HUx - Sanitizar Input\"\n// Este Code va inmediatamente DESPU√âS del Form Trigger de cada HU.\n\n// üîπ Configura ac√° qu√© campos son obligatorios en ESTE formulario\nconst requiredFields = ['$json.email']; // Ej: para HU7 solo Email\n\n// üîπ Listas de valores permitidos\nconst allowedFrecuencia = ['inmediato', 'diario', 'semanal', 'mensual'];\nconst allowedModalidad  = ['remoto', 'presencial', 'hibrido', 'h√≠brido'];\nconst allowedUbicacion  = [\n  'valparaiso',\n  'vi√±a del mar',\n  'quilpue',\n  'villa alemana',\n  'santiago',\n  // agrega las que uses en el form\n];\n\nfunction normStr(v) {\n  if (v === undefined || v === null) return '';\n  return String(v).trim();\n}\n\nfunction isValidEmail(email) {\n  const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return re.test(email);\n}\n\nfunction isValidDateYMD(v) {\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\n  const [y, m, d] = v.split('-').map(Number);\n  const dt = new Date(y, m - 1, d);\n  return (\n    dt.getFullYear() === y &&\n    dt.getMonth() === m - 1 &&\n    dt.getDate() === d\n  );\n}\n\nreturn items.map(item => {\n  const src = item.json || {};\n  const data = {};\n  const errores = [];\n\n  // 1) Copiar y hacer trim de todos los strings\n  for (const [k, v] of Object.entries(src)) {\n    data[k] = typeof v === 'string' ? normStr(v) : v;\n  }\n\n  // 2) Campos obligatorios\n  for (const field of requiredFields) {\n    if (!data[field] || data[field] === '') {\n      errores.push(`Campo obligatorio faltante: ${field}`);\n    }\n  }\n\n  // 3) Normalizar y validar emails (cualquier campo que tenga \"email\" en el nombre)\n  for (const [k, v] of Object.entries(data)) {\n    if (k.toLowerCase().includes('email')) {\n      const em = normStr(v).toLowerCase();\n      if (em === '' || !isValidEmail(em)) {\n        errores.push(`Email inv√°lido en campo \"${k}\": \"${v}\"`);\n      }\n      data[k] = em;\n    }\n  }\n\n  // 4) Validar fechas en formato AAAA-MM-DD\n  for (const [k, v] of Object.entries(data)) {\n    if (typeof v === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(v)) {\n      if (!isValidDateYMD(v)) {\n        errores.push(`Fecha inv√°lida en campo \"${k}\": \"${v}\"`);\n      }\n    }\n  }\n\n  // 5) Validar frecuencia, modalidad, ubicaci√≥n si existen\n  if (data.frecuencia) {\n    const f = normStr(data.frecuencia).toLowerCase();\n    if (!allowedFrecuencia.includes(f)) {\n      errores.push(`Frecuencia no permitida: \"${data.frecuencia}\"`);\n    }\n    data.frecuencia = f;\n  }\n\n  if (data.modalidad) {\n    const m = normStr(data.modalidad).toLowerCase();\n    if (!allowedModalidad.includes(m)) {\n      errores.push(`Modalidad no permitida: \"${data.modalidad}\"`);\n    }\n    data.modalidad = m;\n  }\n\n  if (data.ubicacion) {\n    const u = normStr(data.ubicacion).toLowerCase();\n    if (!allowedUbicacion.includes(u)) {\n      errores.push(`Ubicaci√≥n no permitida: \"${data.ubicacion}\"`);\n    }\n    data.ubicacion = u;\n  }\n\n  // 6) Marcar si pas√≥ o no la validaci√≥n\n  data._ok = errores.length === 0;\n  data._errores = errores;\n\n  return { json: data };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5568,
        1808
      ],
      "id": "81a30a3d-f4b8-411e-97ed-1a538e265ba6",
      "name": "Sanitizar1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $('HU4 - Form Trigger').item.json.Email }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3840,
        1696
      ],
      "id": "dfd51827-d6fb-4558-ace7-79d474242673",
      "name": "Obtener next_run",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('HU4 - Form Trigger').item.json.Email }}",
        "subject": "Error en el registro",
        "html": "=<p>Hola üëã</p>\n\n<p><strong>Has alcanzado tu l√≠mite mensual de reportes inmediatos.</strong></p>\n\n<p>\nHemos recibido tu solicitud, pero actualmente ya utilizaste todos los reportes inmediatos disponibles para este mes.\n</p>\n\n<p>\n<strong>Los cupos se renuevan autom√°ticamente al inicio del pr√≥ximo mes.</strong>\n</p>\n\n<p>\nNo es necesario que realices ninguna acci√≥n. El sistema habilitar√° nuevos reportes de forma autom√°tica cuando se reinicie el per√≠odo mensual.\n</p>\n\n<p>\nMientras tanto, seguir√°s recibiendo tus reportes programados seg√∫n la frecuencia que tengas configurada.\n</p>\n\n<p>\nSi necesitas modificar tus preferencias o tienes alguna duda, puedes responder este correo y te ayudaremos.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -3424,
        1488
      ],
      "id": "5208b942-c99a-4c2f-abcb-b57acbf8a246",
      "name": "limite",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('HU4 - Form Trigger').item.json.Email }}",
        "subject": "Error en el registro",
        "html": "=<p>Hola üëã</p>\n<p><strong>No encontramos una suscripci√≥n asociada a tu correo.</strong></p>\n\n<p>\nHemos recibido tu solicitud de reporte inmediato, pero en el sistema no aparece ning√∫n registro activo con el correo:\n</p>\n\n<p style=\"font-size: 16px; font-weight: bold; margin: 8px 0;\">\n  {{ $('HU4 - Form Trigger').item.json.Email }}\n</p>\n\n<p>\nEsto puede deberse a que:\n</p>\n<ul>\n  <li>A√∫n no te has suscrito al servicio de reportes autom√°ticos.</li>\n  <li>Ingresaste el correo con alg√∫n error de escritura.</li>\n</ul>\n\n<p>\nPor favor, verifica que tu correo est√© correctamente escrito o completa primero el formulario de suscripci√≥n antes de solicitar un reporte inmediato.\n</p>\n\n<p>\nSi crees que se trata de un error, puedes responder a este correo indicando el correo correcto o contactarte con el equipo a trav√©s de los canales habituales.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -4864,
        2000
      ],
      "id": "bfe6329f-8613-4be2-9f9c-75fffeaff740",
      "name": "No existe email HU4",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "lookup",
        "sheetId": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
        "range": "Registro de Inscritos!A:Z",
        "lookupColumn": "Email",
        "lookupValue": "={{ $json.Email }}",
        "options": {
          "returnAllMatches": true
        }
      },
      "id": "92916668-7298-4cee-8fef-85123ee65121",
      "name": "Buscar_Usuario_en_Sheet1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 2,
      "position": [
        -5264,
        1808
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.Email }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "6c17fc10-11f0-4152-b68d-06ebbca124a1",
      "name": "Existe_Usuario?1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -5072,
        1808
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 51153146,
          "mode": "list",
          "cachedResultName": "CantReporte",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=51153146"
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}\n"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('HU4 - Form Trigger').first().json.Email }}"
            },
            {
              "fieldId": "tipo",
              "fieldValue": "=Programado"
            }
          ]
        },
        "options": {}
      },
      "id": "90e04944-ef75-44f8-828d-34388af0b498",
      "name": "HU7 - Registrar Consulta2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        -4912,
        2608
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "html": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -4112,
        2512
      ],
      "id": "739fc125-5f15-4bb0-bfee-764cdd56b3f1",
      "name": "Send email",
      "webhookId": "c8d3c268-f510-472c-b4de-4f38ab0157db",
      "alwaysOutputData": true,
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// === APLANADOR UNIVERSAL + EMAIL BUILDER PRO (Versi√≥n HU4 - Reporte Inmediato) ===\n\n// -----------------------------------------\n// Helpers\n// -----------------------------------------\nfunction esc(s) {\n  return String(s ?? \"\").replace(/[&<>\"']/g, m => ({\n    \"&\": \"&amp;\",\n    \"<\": \"&lt;\",\n    \">\": \"&gt;\",\n    \"\\\"\": \"&quot;\",\n    \"'\": \"&#39;\"\n  }[m]));\n}\n\n// Funci√≥n 'pick' mejorada: devuelve el primer valor v√°lido\nfunction pick(...xs) {\n  for (const x of xs) {\n    if (x !== undefined && x !== null && String(x).trim() !== \"\") return x;\n  }\n  return \"\";\n}\n\n// -----------------------------------------\n// 1) Tomar preferencias REALES del usuario actual\n//    (Adaptado para HU4 usando tus nodos espec√≠ficos)\n// -----------------------------------------\nlet prefRegion = \"No especificada\";\nlet prefModalidad = \"No especificada\";\nlet emailTo = \"\";\nlet nombreUsuario = \"Postulante\";\n\ntry {\n  // Preferencias vienen de \"Obtener Preferencias(HU4)\"\n  // Nota: Usamos first() porque en HU4 procesamos de a un usuario a la vez\n  const prefs = $('Obtener Preferencias(HU4)').first().json || {};\n  prefRegion = prefs['Regi√≥n'] || prefs.region || \"No especificada\";\n  prefModalidad = prefs.Modalidad || prefs.modalidad || \"No especificada\";\n  nombreUsuario = prefs.Nombre || prefs.nombre || \"Postulante\";\n\n  // El email validado viene de \"Sanitizar1\"\n  const datosInput = $('Sanitizar1').first().json || {};\n  emailTo = datosInput.Email || datosInput.email || \"\";\n} catch (e) {\n  // Si falla la lectura de nodos anteriores, no rompemos el flujo\n  console.log(\"Error leyendo preferencias:\", e);\n}\n\n// -----------------------------------------\n// 2) Aplanar y Normalizar Resultados\n// -----------------------------------------\nconst filas = items.map(item => {\n  const raw = item.json || {};\n  \n  // A veces los datos vienen en raw.data (com√∫n en HTTP requests)\n  // Verificamos si existe alguna clave clave en 'raw'\n  const d = (raw.titulo || raw.link || raw.Fuente || raw['fuente '] || raw.fuente) ? raw : (raw.data || raw);\n\n  return {\n    // Buscamos todas las variantes posibles de fuente\n    fuente: pick(d['fuente '], d.fuente, d.Fuente, d.source, d.Source, \"Fuente Desconocida\"),\n    \n    titulo: pick(d.titulo, d.Titulo, d.title, d.Title, d.nombre),\n    empresa: pick(d.empresa, d.Empresa, d.company, \"Sin empresa\"),\n    region: pick(d.region, d.Region, d.ubicacion, \"Sin regi√≥n\"),\n    modalidad: pick(d.modalidad, d.Modalidad, \"Presencial\"),\n    link: pick(d.link, d.Link, d.url, d.href),\n    \n    aviso: d.aviso || \"\"\n  };\n}).filter(r => r.titulo || r.link); // Filtramos filas vac√≠as\n\n// Detectar aviso general (ej: \"No hay remotas, mostrando presenciales\")\nconst avisoGeneral = filas.find(r => r.aviso)?.aviso || \"\";\n\nconst total = filas.length;\n\n// -----------------------------------------\n// 3) M√©tricas por fuente\n// -----------------------------------------\nconst porFuente = {};\nfor (const r of filas) {\n  const f = r.fuente.trim(); \n  porFuente[f] = (porFuente[f] || 0) + 1;\n}\n\nconst stats = Object.entries(porFuente)\n  .map(([k, v]) => `<li><b>${esc(k)}</b>: ${v}</li>`)\n  .join(\"\");\n\n// -----------------------------------------\n// 4) Tabla HTML\n// -----------------------------------------\nconst rowsHtml = filas\n  .map((r, i) => `\n    <tr>\n      <td style=\"text-align:center;color:#555;font-size:12px;\">${i + 1}</td>\n      <td style=\"font-weight:600;color:#111;\">${esc(r.titulo)}</td>\n      <td style=\"color:#444;\">${esc(r.empresa)}</td>\n      <td style=\"color:#666;font-size:13px;\">\n        <span style=\"background:#f3f4f6;padding:2px 6px;border-radius:4px;border:1px solid #e5e7eb;\">\n          ${esc(r.fuente)}\n        </span>\n      </td>\n      <td style=\"text-align:center;\">\n        ${r.link ? `<a href=\"${esc(r.link)}\" target=\"_blank\" style=\"background:#2563eb;color:white;text-decoration:none;padding:6px 12px;border-radius:4px;font-size:13px;display:inline-block;\">Ver</a>` : \"\"}\n      </td>\n    </tr>`\n  ).join(\"\");\n\n// -----------------------------------------\n// 5) Construcci√≥n del HTML final\n// -----------------------------------------\nconst avisoHtml = avisoGeneral\n  ? `<div style=\"margin-bottom:15px;padding:12px;background:#fffbeb;border-left:4px solid #f59e0b;color:#92400e;font-size:14px;border-radius:4px;\">\n       ${esc(avisoGeneral)}\n     </div>`\n  : \"\";\n\nconst html = `\n<div style=\"font-family:'Segoe UI', Helvetica, Arial, sans-serif;max-width:800px;margin:auto;background:#ffffff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;\">\n  \n  <div style=\"background:#2563eb;color:white;padding:20px 24px;\">\n    <h2 style=\"margin:0;font-size:20px;font-weight:600;\">Reporte Inmediato ‚ö°</h2>\n    <p style=\"margin:4px 0 0;opacity:0.9;font-size:14px;\">Hola ${esc(nombreUsuario)}, aqu√≠ tienes el reporte que solicitaste. Encontramos <b>${total}</b> ofertas.</p>\n  </div>\n\n  <div style=\"padding:24px;\">\n    \n    <div style=\"background:#f8fafc;padding:12px 16px;border-radius:6px;border:1px solid #e2e8f0;margin-bottom:20px;font-size:13px;color:#475569;\">\n      <strong>Tu perfil:</strong> ${esc(prefRegion)} ‚Ä¢ ${esc(prefModalidad)}\n    </div>\n\n    ${avisoHtml}\n\n    ${stats ? `<ul style=\"margin:0 0 15px 0;padding-left:20px;color:#64748b;font-size:13px;\">${stats}</ul>` : \"\"}\n\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse;min-width:100%;\">\n      <thead>\n        <tr style=\"border-bottom:2px solid #e2e8f0;\">\n          <th style=\"padding:10px;text-align:center;color:#64748b;font-size:12px;text-transform:uppercase;\">#</th>\n          <th style=\"padding:10px;text-align:left;color:#64748b;font-size:12px;text-transform:uppercase;\">T√≠tulo</th>\n          <th style=\"padding:10px;text-align:left;color:#64748b;font-size:12px;text-transform:uppercase;\">Empresa</th>\n          <th style=\"padding:10px;text-align:left;color:#64748b;font-size:12px;text-transform:uppercase;\">Fuente</th>\n          <th style=\"padding:10px;text-align:center;color:#64748b;font-size:12px;text-transform:uppercase;\">Acci√≥n</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${rowsHtml || `<tr><td colspan=\"5\" style=\"padding:30px;text-align:center;color:#94a3b8;\">No se encontraron resultados nuevos en este momento.</td></tr>`}\n      </tbody>\n    </table>\n\n    <div style=\"margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;font-size:12px;color:#94a3b8;\">\n      Has recibido este correo porque solicitaste un reporte inmediato. <br>\n      Tus reportes programados seguir√°n llegando normalmente.\n    </div>\n  </div>\n</div>\n`;\n\nconst subject = total > 0 \n  ? `‚ö° Reporte Inmediato: ${total} pr√°cticas disponibles` \n  : `Reporte Inmediato: Sin novedades por ahora`;\n\nreturn [{\n  json: {\n    to: emailTo,\n    subject,\n    html,\n    text: `Se encontraron ${total} ofertas para tu reporte inmediato.`,\n    total\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4288,
        2512
      ],
      "id": "9d3c4f8d-c04b-480c-9dca-3423cadab8d1",
      "name": "Build HTML"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8d154a72-080e-415d-a29e-9337eba90379",
              "leftValue": "={{ $json.link || '' }}\n",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5712,
        2480
      ],
      "id": "1602077d-3d94-4060-b936-28b0c3b54f5e",
      "name": "If - link existe (v√°lido)",
      "notes": "TRUE ‚Üí limpiar links ‚Üí remove duplicates ‚Üí filtrar preferencias\nFALSE ‚Üí log a hoja \"Errores\" (timestamp, email, fuente, status, mensaje, preview)\n"
    },
    {
      "parameters": {
        "jsCode": "// Limpia par√°metros de tracking en los links antes de deduplicar\nconst stripParams = [\n  'utm_source','utm_medium','utm_campaign','utm_term','utm_content',\n  'gclid','fbclid','fccid','vjs','from','ad','dq'\n];\n\nreturn items.map(({ json }) => {\n  if (json.link && typeof json.link === 'string') {\n    // normaliza entidades HTML tipo &amp;\n    let href = json.link.trim().replace(/&amp;/g, '&');\n\n    try {\n      // Soporta links relativos (Indeed a veces trae /rc/clk?...):\n      if (href.startsWith('/')) href = 'https://cl.indeed.com' + href;\n\n      const u = new URL(href);\n      // elimina par√°metros de tracking\n      stripParams.forEach(p => u.searchParams.delete(p));\n      // quita el fragmento #...\n      u.hash = '';\n      // normaliza protocolo a https si ven√≠a http\n      if (u.protocol === 'http:') u.protocol = 'https:';\n\n      json.link = u.toString();\n    } catch {\n      // si falla el parseo, al menos quita &amp; y espacios\n      json.link = href;\n    }\n  }\n  return { json };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5440,
        2384
      ],
      "id": "ab4f2d2d-9cc5-40ee-a2f3-03677b6acc43",
      "name": "limpiar links",
      "notes": "A veces el mismo aviso trae el mismo link con par√°metros de tracking distintos"
    },
    {
      "parameters": {
        "jsCode": "// ================================================\n// FILTRAR POR PREFERENCIAS (Versi√≥n FINAL 2025 AJUSTADA)\n// Mantiene tus llamadas EXACTAS a Split In Batches1\n// Incluye mapa de equivalencias de regiones\n// ================================================\n\n\n// === Helpers ===\nfunction normalize(s) {\n    return String(s || \"\")\n        .normalize(\"NFD\")\n        .replace(/[\\u0300-\\u036f]/g, \"\")\n        .toLowerCase()\n        .trim();\n}\n\n// Canon modalidad ‚Üí remoto / hibrido / presencial\nfunction canonModa(s) {\n    const t = normalize(s);\n    if (!t) return \"\";\n\n    if (t.includes(\"remot\")) return \"remoto\";\n    if (t.includes(\"hibrid\") || t.includes(\"mixt\") || t.includes(\"semi\"))\n        return \"hibrido\";\n    if (t.includes(\"presenc\") || t.includes(\"oficin\") || t.includes(\"onsite\"))\n        return \"presencial\";\n\n    return \"\";\n}\n\n\n// ================================================\n// NUEVO: MAPA DE REGIONES ‚Üí Para igualar VIII, Concepci√≥n, B√≠o B√≠o, etc.\n// ================================================\nconst REGION_MAP = {\n    \"region metropolitana\": [\"rm\", \"metropolitana\", \"santiago\"],\n    \"region de valparaiso\": [\"region v\", \"valparaiso\"],\n    \"region del biobio\": [\"region viii\", \"concepcion\", \"bio bio\", \"b√≠o b√≠o\"],\n    \"region de coquimbo\": [\"region iv\", \"coquimbo\", \"la serena\"],\n    \"region de atacama\": [\"region iii\"],\n    \"region de antofagasta\": [\"region ii\", \"antofagasta\"],\n    \"region de tarapaca\": [\"region i\", \"iquique\"],\n    \"region de arica y parinacota\": [\"region xv\", \"arica\"],\n    \"region del maule\": [\"region vii\", \"maule\", \"talca\"],\n    \"region de ohiggins\": [\"region vi\", \"ohiggins\", \"rancagua\"],\n    \"region de los lagos\": [\"region x\", \"puerto montt\"],\n    \"region de los rios\": [\"region xiv\", \"valdivia\"],\n    \"region de aysen\": [\"region xi\", \"aysen\"],\n    \"region de magallanes\": [\"region xii\", \"punta arenas\"],\n};\n\n// Canon regi√≥n\nfunction canonRegion(txt) {\n    const clean = normalize(txt);\n\n    for (const [std, aliases] of Object.entries(REGION_MAP)) {\n        if (clean.includes(std)) return std;\n\n        for (const a of aliases) {\n            if (clean.includes(a)) return std;\n        }\n    }\n\n    return clean; // fallback\n}\n\n\n// ================================================\n// 1) OBTENER PREFERENCIAS (mantengo EXACTAMENTE tus llamadas)\n// ================================================\nconst prefRegionRaw =$('Obtener Preferencias(HU4)').first().json['Regi√≥n'] || \"\";\nconst prefModaRaw   = $('Obtener Preferencias(HU4)').first().json.Modalidad|| \"\";\n\nconst prefRegion = canonRegion(prefRegionRaw);\nconst prefModa   = canonModa(prefModaRaw);\n\n\n// ================================================\n// 2) FILTROS AJUSTADOS\n// ================================================\nfunction matchRegion(prefRegion, regionItem) {\n    if (!prefRegion) return true;\n    return canonRegion(regionItem) === prefRegion;\n}\n\nfunction matchModa(prefModa, itemModa) {\n    if (!prefModa) return true;\n\n    if (prefModa === \"remoto\") {\n        return itemModa === \"remoto\" || itemModa === \"hibrido\";\n    }\n\n    return itemModa === prefModa;\n}\n\n\n// ================================================\n// 3) PROCESAR OFERTAS (mantengo EXACTO tu bloque)\n// ================================================\nconst out = [];\n\nfor (const { json } of items) {\n    if (!json.link) continue;\n\n    const regionItem = json.region || \"\";\n\n    const modaItem =\n        canonModa(json.modalidad) ||\n        canonModa(json.region) ||\n        canonModa(json.titulo) ||\n        \"presencial\";\n\n    if (matchRegion(prefRegion, regionItem) && matchModa(prefModa, modaItem)) {\n        out.push({ json: { ...json, modalidad: modaItem } });\n    }\n}\n\n\n// ================================================\n// 4) DEBUG SI NO HAY COINCIDENCIAS\n// ================================================\nif (out.length === 0) {\n    return [{\n        json: {\n            msg: \"Sin coincidencias\",\n            prefRegionRaw,\n            prefRegion,\n            prefModa,\n            total_in: items.length\n        }\n    }];\n}\n\n\n// ================================================\n// 5) RESULTADO FINAL\n// ================================================\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5072,
        2384
      ],
      "id": "687aa7b0-90e2-4481-a139-4b9435f288a4",
      "name": "Filtrar por preferencias"
    },
    {
      "parameters": {
        "compare": "selectedFields",
        "fieldsToCompare": "link",
        "options": {}
      },
      "type": "n8n-nodes-base.removeDuplicates",
      "typeVersion": 2,
      "position": [
        -5264,
        2384
      ],
      "id": "68e465ca-33cf-41ba-ae39-c706cfe8377d",
      "name": "Remove Duplicates",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1xhrrKc9J4yluGKOtezrDkrAui_L5t-1FaHIoyaPLC8E",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1368021364,
          "mode": "list",
          "cachedResultName": "Errores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1xhrrKc9J4yluGKOtezrDkrAui_L5t-1FaHIoyaPLC8E/edit#gid=1368021364"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $now }}",
            "email": "={{ $('Split In Batches1').item.json.email }}",
            "fuente": "={{ $json.fuente || \"desconocida\" }}",
            "status": "={{ $json.statusCode || $json.code || \"\" }}",
            "mensaje": "={{ $json.mensaje || $json.error || \"sin datos\" }}",
            "preview": "={{ $json | json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fuente",
              "displayName": "fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensaje",
              "displayName": "mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "preview",
              "displayName": "preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -5376,
        2592
      ],
      "id": "b11b861b-c9a5-48a8-8d11-dafe2db7befc",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{ $('HU4 - Form Trigger').item.json.Email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8f19aacf-0ca5-49f4-a4cd-7de46f35e5d7",
      "name": "HU13 - Get L√≠mite (HU4)",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -4720,
        1792
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos desde los nodos anteriores\nconst limiteRow   = $items('HU13 - Get L√≠mite (HU4)')[0]?.json || {};\nconst consumoRow  = $items('HU13 - Get Consumo Actual(HU4)')[0]?.json || {};\nconst emailRow    = $items('Sanitizar1')[0]?.json || {};\n\n// Convertir valores\nconst limite        = Number(limiteRow.limite || 0);\nconst usados_actual = Number(consumoRow.usados || 0);\n\n// Incremento\nconst usados_nuevo = usados_actual + 1;\n\n// Mes actual YYYY-MM\nconst mes = new Date().toISOString().slice(0, 7);\n\n// Timestamp\nconst actualizado_ts = new Date().toISOString();\n\n// Devolver un √∫nico item limpio (formato n8n)\nreturn [\n  {\n    json: {\n      email: emailRow.email || '',\n      limite,\n      usados_actual,\n      usados_nuevo,\n      mes,\n      actualizado_ts\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3904,
        2512
      ],
      "id": "ebd60914-0dde-437c-90cf-78a4519f2eee",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{ $json.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "7948c0bc-7714-4ac6-86c1-befd72997e4f",
      "name": "HU13 - Get Consumo Actual(HU4)",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -4464,
        1792
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?pli=1&gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $('Sanitizar1').item.json.Email }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3600,
        1872
      ],
      "id": "28fe6dc3-0aeb-473c-a6d9-701831f6d652",
      "name": "Obtener Preferencias(HU4)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const limiteRow = $items('HU13 - Get L√≠mite (HU4)')[0].json;\nconst consumoRow = $items('HU13 - Get Consumo Actual(HU4)')[0].json;\n\nconst limite = Number(limiteRow.limite || 0);\nconst usados = Number(consumoRow.usados || 0);\n\nreturn [{\n  exceeded: usados >= limite,\n  limite,\n  usados\n}];\n"
      },
      "id": "d8c91da3-71ff-42f9-8e40-1026d80e8414",
      "name": "HU13 - IF excede l√≠mite? (HU4)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4240,
        1792
      ]
    },
    {
      "parameters": {
        "content": "HU4 - Reporte Inmediato - Integrada con HU13",
        "height": 80,
        "width": 304,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5232,
        1616
      ],
      "id": "c09c0935-56c5-4748-acb2-7b03b2de2353",
      "name": "Sticky Note",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $('HU4 - Form Trigger').first().json.Email }}",
            "mes": "={{ $now.format('yyyy-MM') }}",
            "limite": "={{ $('HU13 - Get L√≠mite (HU4)').first().json.limite }}",
            "usados": "={{ $json.usados_nuevo }}",
            "actualizado_ts": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}\n\n"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "limite",
              "displayName": "limite",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "usados",
              "displayName": "usados",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes",
              "displayName": "mes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "actualizado_ts",
              "displayName": "actualizado_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "key",
              "displayName": "key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "fb344acd-7e07-4c36-a8af-272008086fec",
      "name": "HU13 - Incrementar Consumo1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -3664,
        2512
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const u = $json;\nreturn [{ email: u.Email, region: u[\"Regi√≥n\"], modalidad: u[\"Modalidad\"], q: \"pr√°ctica inform√°tica\" }];"
      },
      "id": "85ac899f-78e0-4277-8b36-0a30b20ac74a",
      "name": "HU4 - Build Query",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3328,
        1904
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "mensaje",
              "value": "Has alcanzado tu l√≠mite mensual de reportes on-demand."
            }
          ]
        },
        "options": {}
      },
      "id": "f0df40b7-19fa-442d-a83a-7d3f189c906a",
      "name": "HU13 - Mensaje L√≠mite Alcanzado",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -3632,
        1568
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "93a61adf-edb1-4f5b-9b19-b8db59842231",
              "leftValue": "={{ $json.exceeded }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4e72d29c-42c4-4d04-8829-ec42c7e9a112",
      "name": "HU13 - IF (exceeded?)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -4048,
        1792
      ]
    },
    {
      "parameters": {
        "formTitle": "Solicitud de reporte inmediato",
        "formDescription": "Genera un reporte inmediato usando tus preferencias guardadas.",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Email",
              "fieldType": "email",
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "id": "7e47f73d-dec0-4517-b2c0-bedf130bd6bc",
      "name": "HU4 - Form Trigger",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.3,
      "position": [
        -5888,
        1808
      ],
      "webhookId": "hu4_form_001"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1xhrrKc9J4yluGKOtezrDkrAui_L5t-1FaHIoyaPLC8E",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1368021364,
          "mode": "list",
          "cachedResultName": "Errores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1xhrrKc9J4yluGKOtezrDkrAui_L5t-1FaHIoyaPLC8E/edit#gid=1368021364"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}\n",
            "email": "={{ $('Split In Batches').item.json.email }}",
            "fuente": "={{ $json.fuente || \"desconocida\" }}",
            "status": "={{ $json.statusCode || $json.code || \"\" }}",
            "mensaje": "={{ $json.mensaje || $json.error || \"sin datos\" }}",
            "preview": "={{ $json | json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fuente",
              "displayName": "fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensaje",
              "displayName": "mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "preview",
              "displayName": "preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2576,
        3376
      ],
      "id": "3bf0f9eb-5d15-4ff6-96f9-913f622da9d1",
      "name": "Append row in sheet3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// --- helpers robustos para convertir next_run ---\nfunction toDate(x) {\n  if (x == null || x === '') return null;\n\n  // Log del valor original\n  console.log(\"raw next_run:\", x);\n\n  if (typeof x === 'number') {\n    // Estilo fecha Excel (por si Google Sheets lo manda as√≠)\n    const base = new Date(Date.UTC(1899, 11, 30));\n    const d = new Date(base.getTime() + x * 86400000);\n    console.log(\"‚Üí parsed as number:\", d);\n    return d;\n  }\n\n  let s = String(x).trim();\n  console.log(\"raw string:\", s);\n\n  // Normalizar \"2025-12-08 0:46:34\" ‚Üí \"2025-12-08T00:46:34\"\n  const m = s.match(/^(\\d{4}-\\d{2}-\\d{2})\\s+(\\d{1,2}):(\\d{2}):(\\d{2})$/);\n  if (m) {\n    const [, date, h, mi, se] = m;\n    s = `${date}T${h.padStart(2, '0')}:${mi}:${se}`;\n  } else if (!s.includes('T')) {\n    s = s.replace(' ', 'T');\n  }\n\n  let d = new Date(s);\n  console.log(\"‚Üí parsed direct:\", d);\n\n  if (!isNaN(d)) return d;\n\n  d = new Date(s + 'Z');\n  console.log(\"‚Üí parsed as UTC:\", d);\n\n  return isNaN(d) ? null : d;\n}\n\nconst now = new Date();\nconsole.log(\"NOW:\", now);\n\nconst out = [];\nlet skipped = 0;\n\nfor (const it of items) {\n  const r = it.json || {};\n  const raw = r.next_run ?? r.Next_run ?? r['next_run'];\n\n  console.log(\"ITEM:\", r);\n  console.log(\"next_run FIELD BEFORE PARSING:\", raw);\n\n  const d = toDate(raw);\n\n  console.log(\"parsed date:\", d);\n\n  // üî¥ CAMBIO CLAVE:\n  // Si NO se puede parsear (d == null), lo dejamos pasar una vez\n  if (!d) {\n    console.log(\"‚ö† next_run inv√°lido o vac√≠o ‚Üí FORZAR PASO UNA VEZ\");\n    out.push(it);\n    continue;\n  }\n\n  if (d <= now) {\n    console.log(\"‚úî next_run vencido ‚Üí PASA\");\n    out.push(it);\n  } else {\n    console.log(\"‚ùå next_run futuro ‚Üí SKIP\");\n    skipped++;\n  }\n}\n\nconsole.log(\"TOTAL PASAN:\", out.length);\n\n// Si nadie pasa, simplemente devolvemos vac√≠o (no sigue el flujo)\nreturn out;\n"
      },
      "id": "588ed83d-2bc2-4106-bed8-1423e3249e09",
      "name": "Filtrar por next_run",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2368,
        2416
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// === Normalizar payload (Versi√≥n Corregida para M√∫ltiples √çtems) ===\n\n// Helpers\nfunction pick(obj, keys) {\n  for (const k of keys) {\n    if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') {\n      return obj[k];\n    }\n  }\n  return '';\n}\n\nfunction limpiarRegion(txt) {\n  if (!txt) return '';\n  return String(txt).split(/[‚Äì-]/)[0].trim();\n}\n\n// Procesamos TODOS los items que entran, no solo el primero\nconst resultados = items.map(item => {\n  const r = item.json || {};\n\n  // üöß Filtro de seguridad b√°sico\n  if (!r.Email && !r.email && !r.Regi√≥n && !r.Region && !r.region) {\n    return null; \n  }\n\n  // Extracci√≥n de datos\n  const email      = String(pick(r, ['Email','email'])).trim();\n  const modalidad  = String(pick(r, ['Modalidad','modalidad'])).trim();\n  const regionRaw  = pick(r, ['Regi√≥n','Region','region','REGION']);\n  const frecuencia = String(pick(r, ['Frecuencia','frecuencia'])).trim();\n  const next_run   = pick(r, ['next_run', 'Next_run']); // Tomamos el del item actual\n  const nombre     = pick(r, ['Nombre', 'nombre']);\n\n  return {\n    json: {\n      email,\n      nombre,\n      modalidad,\n      region: limpiarRegion(regionRaw),\n      frecuencia,\n      next_run,\n      status: 'READY'\n    }\n  };\n});\n\n// Filtramos los nulos (por si hubo datos vac√≠os)\nreturn resultados.filter(i => i !== null);"
      },
      "id": "5762357d-39d6-4b5a-bbc1-b928210d2c9c",
      "name": "Normalizar payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        2416
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "e835c5cb-2087-420d-80ad-1fc278b83835",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        2800,
        2416
      ]
    },
    {
      "parameters": {
        "url": "https://r.jina.ai/https://www.laborum.cl/empleos-busqueda-practica-informatica.html",
        "allowUnauthorizedCerts": true,
        "responseFormat": "string",
        "jsonParameters": true,
        "options": {
          "followAllRedirects": true,
          "ignoreResponseCode": true
        },
        "headerParametersJson": "{\n  \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0\",\n  \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\",\n  \"Accept-Language\": \"es-CL,es;q=0.9\",\n  \"Accept-Encoding\": \"gzip, deflate, br\",\n  \"Connection\": \"keep-alive\",\n  \"Upgrade-Insecure-Requests\": \"1\",\n  \"Cache-Control\": \"no-cache\",\n  \"Pragma\": \"no-cache\"\n}\n"
      },
      "id": "a6a2ebff-8557-485f-8abd-4e98c64222ab",
      "name": "HTTP Laborum (placeholder)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        4880,
        2304
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "compare": "selectedFields",
        "fieldsToCompare": "link",
        "options": {}
      },
      "type": "n8n-nodes-base.removeDuplicates",
      "typeVersion": 2,
      "position": [
        2688,
        3168
      ],
      "id": "fd9ced92-7024-4362-8b3a-69d794e866ba",
      "name": "Remove Duplicates2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ================================================\n// Helpers\n// ================================================\nfunction normalize(s) {\n    return String(s || \"\")\n        .normalize(\"NFD\")\n        .replace(/[\\u0300-\\u036f]/g, \"\")\n        .toLowerCase()\n        .trim();\n}\n\nfunction canonModa(s) {\n    const t = normalize(s);\n    if (!t) return \"\";\n    if (t.includes(\"remot\") || t.includes(\"teletrabajo\")) return \"remoto\";\n    if (t.includes(\"hibrid\") || t.includes(\"mixt\") || t.includes(\"semi\")) return \"hibrido\";\n    if (t.includes(\"presenc\") || t.includes(\"oficin\") || t.includes(\"onsite\")) return \"presencial\";\n    return \"\";\n}\n\n// Mapa de Regiones (Expandido)\nconst REGION_MAP = {\n    \"region metropolitana\": [\"rm\", \"metropolitana\", \"santiago\", \"las condes\", \"providencia\", \"quilicura\", \"huechuraba\", \"maipu\", \"lampa\", \"colina\", \"pudahuel\"],\n    \"region de valparaiso\": [\"region v\", \"valparaiso\", \"vi√±a\", \"quilpue\", \"villa alemana\"],\n    \"region del biobio\": [\"region viii\", \"concepcion\", \"bio bio\", \"b√≠o b√≠o\", \"talcahuano\"],\n    \"region de antofagasta\": [\"region ii\", \"antofagasta\", \"calama\"],\n    \"region del maule\": [\"region vii\", \"maule\", \"talca\", \"curico\", \"linares\"],\n    \"region de ohiggins\": [\"region vi\", \"rancagua\", \"ohiggins\", \"o'higgins\"],\n};\n\nfunction canonRegion(txt) {\n    const clean = normalize(txt);\n    for (const [std, aliases] of Object.entries(REGION_MAP)) {\n        if (clean.includes(std)) return std;\n        for (const a of aliases) {\n            if (clean.includes(a)) return std;\n        }\n    }\n    return clean; \n}\n\nfunction matchRegion(prefRegion, regionItem) {\n    // Si el usuario no pidi√≥ regi√≥n o dice \"todas\", pasa todo\n    if (!prefRegion || prefRegion === \"todas\" || prefRegion === \"no especificada\") return true;\n    \n    const rItem = canonRegion(regionItem);\n    const rPref = canonRegion(prefRegion);\n\n    // Coincidencia estricta o parcial\n    if (rItem === rPref) return true;\n    if (rItem.includes(rPref) || rPref.includes(rItem)) return true;\n\n    return false;\n}\n\n// ================================================\n// 1. Obtener preferencias\n// ================================================\nlet prefRegion = \"\";\nlet prefModa = \"\";\n\ntry {\n    // Intentamos buscar \"Split In Batches\", si falla probamos con \"Split In Batches1\"\n    let prefsNode = $('Split In Batches').first().json; \n    if (!prefsNode) try { prefsNode = $('Split In Batches1').first().json; } catch(e){}\n\n    const prefs = prefsNode || {};\n    prefRegion = prefs.region || prefs.Regi√≥n || \"\";\n    prefModa = canonModa(prefs.modalidad || prefs.Modalidad || \"\");\n    \n} catch (e) {\n    console.log(\"Error leyendo preferencias: \", e.message);\n}\n\nconsole.log(`Usuario actual pide: Regi√≥n [${prefRegion}] - Modalidad [${prefModa}]`);\n\n// ================================================\n// 2. Clasificar ofertas\n// ================================================\nconst exactas = [];\nconst alternativas = [];\n\nfor (const item of items) {\n    const json = item.json;\n\n    // --- üö¶ PASE VIP PARA ERRORES (¬°CR√çTICO!) ---\n    // Si es un error (es_error: true), lo dejamos pasar DIRECTO.\n    // No filtramos por regi√≥n porque los errores no tienen ubicaci√≥n.\n    if (json.es_error) {\n        exactas.push({ json });\n        continue; // Saltamos el resto del bucle para este item\n    }\n    // -------------------------------------------\n\n    if (!json.link) continue;\n\n    // Buscamos regi√≥n\n    const regionItem = json.region || json.ubicacion || \"\";\n    \n    // FILTRO DE REGI√ìN: Si no coincide, 'continue' (salta al siguiente)\n    if (!matchRegion(prefRegion, regionItem)) {\n        continue;\n    }\n\n    // Normalizamos modalidad de la oferta\n    const modaItem = canonModa(json.modalidad) || canonModa(json.region) || \"presencial\";\n\n    // L√≥gica de Modalidad\n    const coincideModa =\n        prefModa === \"\" || \n        prefModa === \"no especificada\" ||\n        prefModa === modaItem ||\n        (prefModa === \"remoto\" && modaItem === \"hibrido\");\n\n    if (coincideModa) {\n        exactas.push({ json: { ...json, modalidad: modaItem } });\n    } else {\n        alternativas.push({ json: { ...json, modalidad: modaItem } });\n    }\n}\n\n// ================================================\n// 3. RETORNO\n// ================================================\n\n// Prioridad 1: Exactas (Ofertas que coinciden + Errores)\nif (exactas.length > 0) return exactas;\n\n// Prioridad 2: Alternativas (Misma regi√≥n, distinta modalidad)\nif (alternativas.length > 0) {\n    return alternativas.map(item => ({\n        json: {\n            ...item.json,\n            aviso: `No hay ofertas ${prefModa}, mostrando ${item.json.modalidad}`\n        }\n    }));\n}\n\n// Prioridad 3: Nada\nreturn [{\n    json: {\n        msg: \"Sin coincidencias\",\n        prefRegion,\n        prefModa,\n        total_in: items.length\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        3168
      ],
      "id": "39a0f047-7d6f-4375-a247-413b1c570708",
      "name": "Filtrar por preferencias2"
    },
    {
      "parameters": {
        "jsCode": "// Limpia par√°metros de tracking (Ignorando Errores)\nconst stripParams = [\n  'utm_source','utm_medium','utm_campaign','utm_term','utm_content',\n  'gclid','fbclid','fccid','vjs','from','ad','dq'\n];\n\nreturn items.map(({ json }) => {\n  // PASE VIP: Si es error, no tocamos nada, pasa directo\n  if (json.es_error) return { json };\n\n  if (json.link && typeof json.link === 'string') {\n    let href = json.link.trim().replace(/&amp;/g, '&');\n    try {\n      if (href.startsWith('/')) href = 'https://cl.indeed.com' + href;\n      const u = new URL(href);\n      stripParams.forEach(p => u.searchParams.delete(p));\n      u.hash = '';\n      if (u.protocol === 'http:') u.protocol = 'https:';\n      json.link = u.toString();\n    } catch {\n      json.link = href;\n    }\n  }\n  return { json };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2512,
        3168
      ],
      "id": "6ed0c4da-9a23-48be-b2c7-34ff322a4d58",
      "name": "limpiar links2",
      "notes": "A veces el mismo aviso trae el mismo link con par√°metros de tracking distintos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8d154a72-080e-415d-a29e-9337eba90379",
              "leftValue": "={{ $json.link || '' }}\n",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "25fab311-6c84-4157-8f1a-c30427a7fff7",
              "leftValue": "={{ $json.es_error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2192,
        3312
      ],
      "id": "77dda78c-a59a-4f3e-8e71-936219f29892",
      "name": "If - link existe (v√°lido)2",
      "notes": "TRUE ‚Üí limpiar links ‚Üí remove duplicates ‚Üí filtrar preferencias\nFALSE ‚Üí log a hoja \"Errores\" (timestamp, email, fuente, status, mensaje, preview)\n"
    },
    {
      "parameters": {
        "jsCode": "// === BUILD HTML - VERSI√ìN FINAL SIMPLE ===\n\n// 1. Helpers de limpieza\nfunction esc(s) {\n  // Escapa caracteres para no romper el HTML\n  if (!s) return \"\";\n  return String(s)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#39;\");\n}\n\nfunction pick(...xs) {\n  for (const x of xs) if (x && String(x).trim() !== \"\") return x;\n  return \"\";\n}\n\n// 2. Preferencias (Datos del usuario)\nlet prefRegion = \"No especificada\";\nlet prefModalidad = \"No especificada\";\nlet emailTo = \"\";\nlet nombreUsuario = \"Estudiante\";\n\ntry {\n  const meta = $('Split In Batches').first().json || {};\n  prefRegion = meta.region || meta.Regi√≥n || prefRegion;\n  prefModalidad = meta.modalidad || meta.Modalidad || prefModalidad;\n  emailTo = meta.email || meta.Email || \"\";\n  nombreUsuario = meta.nombre || meta.Nombre || \"Estudiante\";\n} catch (e) { }\n\n// 3. CLASIFICACI√ìN (La l√≥gica simple que pediste)\nconst ofertas = [];\nconst errores = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // A. ¬øEs un Error? -> A la lista de culpables\n  if (data.es_error) {\n    errores.push({\n      fuente: data.fuente || \"Fuente Desconocida\",\n      mensaje: data.mensaje || \"Error de conexi√≥n\"\n    });\n    continue; \n  }\n\n  // B. ¬øEs una Oferta? -> A la tabla\n  const d = (data['fuente '] || data.titulo || data.link) ? data : (data.data || data);\n  const oferta = {\n    fuente: pick(d.fuente, d['fuente '], \"Desconocida\"),\n    titulo: pick(d.titulo, d.title),\n    empresa: pick(d.empresa, \"Empresa Confidencial\"),\n    link: pick(d.link, d.url),\n    aviso: d.aviso || \"\"\n  };\n\n  if (oferta.titulo && oferta.link) {\n    ofertas.push(oferta);\n  }\n}\n\nconst totalOfertas = ofertas.length;\nconst totalErrores = errores.length;\n\n// 4. CONSTRUCCI√ìN VISUAL\n\n// --- CAJA ROJA DE ERRORES (Si hay alguno) ---\nlet htmlErrores = \"\";\nif (totalErrores > 0) {\n  // Creamos la lista simple: \"Laborum: Error 404\"\n  const listaItems = errores.map(e => \n    `<li><b>${esc(e.fuente)}:</b> ${esc(e.mensaje)}</li>`\n  ).join(\"\");\n\n  htmlErrores = `\n    <div style=\"margin-bottom:20px; padding:15px; background-color:#fff1f2; border: 1px solid #fda4af; border-radius:6px; color:#9f1239;\">\n      <h3 style=\"margin:0 0 8px 0; font-size:14px; font-weight:bold;\">‚ö†Ô∏è Hubo problemas con algunas fuentes:</h3>\n      <ul style=\"margin:0; padding-left:20px; font-size:13px;\">\n        ${listaItems}\n      </ul>\n      <p style=\"margin:8px 0 0 0; font-size:11px; opacity:0.8;\">\n        Intentaremos consultar estas fuentes de nuevo en la pr√≥xima ejecuci√≥n.\n      </p>\n    </div>\n  `;\n}\n\n// --- TABLA DE OFERTAS ---\nconst rowsHtml = ofertas.map((r, i) => `\n    <tr style=\"border-bottom: 1px solid #e5e7eb;\">\n      <td style=\"padding:10px;text-align:center;color:#6b7280;font-size:12px;\">${i + 1}</td>\n      <td style=\"padding:10px;font-weight:600;color:#111827;\">${esc(r.titulo)}</td>\n      <td style=\"padding:10px;color:#374151;\">${esc(r.empresa)}</td>\n      <td style=\"padding:10px;color:#4b5563;font-size:12px;\">\n        <span style=\"background:#f3f4f6;padding:2px 6px;border-radius:4px;\">${esc(r.fuente)}</span>\n      </td>\n      <td style=\"padding:10px;text-align:center;\">\n        <a href=\"${esc(r.link)}\" target=\"_blank\" style=\"background:#2563eb;color:white;text-decoration:none;padding:6px 12px;border-radius:4px;font-size:12px;display:inline-block;\">Ver</a>\n      </td>\n    </tr>`\n).join(\"\");\n\n// Mensaje si tabla vac√≠a\nlet mensajeVacio = \"No hay resultados nuevos.\";\nif (totalOfertas === 0 && totalErrores > 0) {\n  mensajeVacio = \"No pudimos cargar ofertas por los errores reportados arriba.\";\n}\nconst tablaBody = rowsHtml || `<tr><td colspan=\"5\" style=\"padding:30px;text-align:center;color:#9ca3af;\">${mensajeVacio}</td></tr>`;\n\n// 5. ASUNTO DEL CORREO\nlet subject = `Resultados: ${totalOfertas} ofertas encontradas`;\nif (totalErrores > 0) {\n  subject += ` (‚ö†Ô∏è ${totalErrores} errores)`;\n}\nif (totalOfertas === 0 && totalErrores > 0) {\n  subject = \"Alerta: Error al buscar pr√°cticas\";\n}\n\n// 6. HTML FINAL\nconst html = `\n<div style=\"font-family:sans-serif; max-width:800px; margin:auto; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;\">\n  <div style=\"background:#2563eb; color:white; padding:20px;\">\n    <h2 style=\"margin:0; font-size:20px;\">Hola ${esc(nombreUsuario)} üëã</h2>\n    <p style=\"margin:5px 0 0; opacity:0.9; font-size:14px;\">Reporte de Pr√°cticas</p>\n  </div>\n\n  <div style=\"padding:20px;\">\n    <div style=\"background:#f9fafb; padding:10px; border-radius:6px; margin-bottom:20px; font-size:13px; color:#4b5563;\">\n      B√∫squeda: <strong>${esc(prefRegion)}</strong> ‚Ä¢ ${esc(prefModalidad)}\n    </div>\n\n    ${htmlErrores}\n\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse;\">\n      <thead>\n        <tr style=\"border-bottom:2px solid #e5e7eb; background:#f9fafb;\">\n          <th style=\"padding:10px; font-size:12px; color:#4b5563; text-align:center;\">#</th>\n          <th style=\"padding:10px; font-size:12px; color:#4b5563; text-align:left;\">T√çTULO</th>\n          <th style=\"padding:10px; font-size:12px; color:#4b5563; text-align:left;\">EMPRESA</th>\n          <th style=\"padding:10px; font-size:12px; color:#4b5563; text-align:left;\">FUENTE</th>\n          <th style=\"padding:10px; font-size:12px; color:#4b5563; text-align:center;\">LINK</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${tablaBody}\n      </tbody>\n    </table>\n    \n    <div style=\"margin-top:30px; text-align:center; font-size:12px; color:#9ca3af;\">\n      Enviado autom√°ticamente ü§ñ\n    </div>\n  </div>\n</div>\n`;\n\nreturn [{\n  json: {\n    to: emailTo,\n    subject: subject,\n    html: html,\n    total: totalOfertas,\n    errores: totalErrores\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        3264
      ],
      "id": "2b118285-5036-43f5-9874-35fa782d7b18",
      "name": "Build HTML2"
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "html": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        3904,
        3264
      ],
      "id": "f61c189a-c334-4508-9315-d6d7f1622cf1",
      "name": "Send email4",
      "webhookId": "c8d3c268-f510-472c-b4de-4f38ab0157db",
      "alwaysOutputData": true,
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Toma el usuario actual desde \"Split In Batches\"\nconst u = $json || {};\n\n// --- Helpers ---\nfunction norm(s) {\n  return String(s || '')\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') // quita tildes\n    .toLowerCase()\n    .trim();\n}\n\nfunction formatLocal(dt) {\n  const pad = n => String(n).padStart(2, '0');\n  return (\n    dt.getFullYear() + '-' +\n    pad(dt.getMonth() + 1) + '-' +\n    pad(dt.getDate()) + ' ' +\n    pad(dt.getHours()) + ':' +\n    pad(dt.getMinutes()) + ':' +\n    pad(dt.getSeconds())\n  );\n}\n\n// --- L√≥gica Inteligente de Fechas ---\nfunction nextFrom(freq, base = new Date()) {\n  const f = norm(freq);\n  const d = new Date(base);\n\n  // 1. Extraer el n√∫mero (si existe)\n  // Busca d√≠gitos en el texto. Si encuentra \"3 dias\", saca el 3.\n  // Si no encuentra n√∫mero (ej: \"diario\", \"semanal\", \"mensual\"), asume 1.\n  const numeros = f.match(/(\\d+)/);\n  let cantidad = numeros ? parseInt(numeros[1], 10) : 1;\n\n  // 2. Aplicar l√≥gica seg√∫n la palabra clave\n  \n  // MINUTOS\n  if (f.includes('min')) {\n    d.setMinutes(d.getMinutes() + cantidad);\n  }\n  // SEMANAS (semana, semanal, sem)\n  else if (f.includes('sem')) { \n    d.setDate(d.getDate() + (cantidad * 7));\n  }\n  // MESES (mes, mensual, meses)\n  else if (f.includes('mes')) {\n    d.setMonth(d.getMonth() + cantidad);\n  }\n  // D√çAS (dia, dias, diario)\n  else if (f.includes('dia') || f.includes('diario')) {\n    d.setDate(d.getDate() + cantidad);\n  }\n  // HORAS (detectar \"24h\" o \"horas\")\n  else if (f.includes('hora') || f.includes('h')) {\n    // Caso especial: \"24h\" a veces se usa como sin√≥nimo de diario\n    if (f.includes('24') && f.includes('h')) {\n       d.setDate(d.getDate() + 1);\n    } else {\n       d.setHours(d.getHours() + cantidad);\n    }\n  }\n  // FALLBACK (Si no entiende nada, default 7 d√≠as)\n  else {\n    // Si viene vac√≠o o texto raro, por seguridad 1 semana\n    d.setDate(d.getDate() + 7);\n  }\n\n  return formatLocal(d);\n}\n\n// Ejecuci√≥n\nreturn [{\n  json: {\n    Email: u.email || u.Email,\n    next_run: nextFrom(u.frecuencia || u.Frecuencia)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4080,
        3264
      ],
      "id": "e268ae1c-a13f-417e-989e-4bf7f5f75b0b",
      "name": "Bump next_run"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        1952,
        2416
      ],
      "id": "e4b5cd75-51ae-40bc-bab0-81f572d9e332",
      "name": "Schedule Trigger2",
      "alwaysOutputData": false,
      "executeOnce": false,
      "notesInFlow": false
    },
    {
      "parameters": {
        "content": "HU6 y HU 5\nReporte completo y consulta plataformas",
        "height": 96,
        "width": 304,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2512,
        2192
      ],
      "id": "ce71890d-e48a-4440-baf8-c361f659747f",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "Integracion HU13",
        "height": 80,
        "width": 192,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2864,
        2192
      ],
      "id": "b11b1538-aab0-4786-a3f2-599c54f47edd",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "jsCode": "const limiteRow = $items('HU13 - Get L√≠mite (HU6)1')[0].json;\nconst consumoRow = $items('HU13 - Get Consumo Actual1')[0].json;\n\nconst limite = Number(limiteRow.limite || 0);\nconst usados = Number(consumoRow.usados || 0);\n\nreturn [{\n  exceeded: usados >= limite,\n  limite,\n  usados\n}];\n"
      },
      "id": "5e6f0019-e99c-40da-82dc-75b759864b27",
      "name": "HU13 - IF excede l√≠mite? (Code)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3696,
        2416
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "8575828d-ac1f-4ec8-9eab-356927b4ba57",
              "leftValue": "={{ $json.exceeded }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "63ad467a-bd49-4c7a-a8c9-e9fef536a396",
              "leftValue": "={{ $json.estado }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "71c6c243-b6da-498c-8438-a0498c599a00",
      "name": "HU13 - IF (exceeded?)2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3904,
        2416
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{ email: String($json.email).trim().toLowerCase() }];"
      },
      "id": "3bac6210-6f4c-4a5d-969f-a6f799105441",
      "name": "HU13 - Normalizar Email1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3008,
        2416
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{ $('Split In Batches').item.json.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1cb13496-d56c-4961-9df0-5cf62f6c331b",
      "name": "HU13 - Get Consumo Actual1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        3472,
        2416
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{ $json.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "98722f6d-6e65-4f8f-9424-1a1e30ca6a65",
      "name": "HU13 - Get L√≠mite (HU6)1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        3232,
        2416
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "mensaje",
              "value": "Has alcanzado tu l√≠mite mensual de reportes."
            }
          ]
        },
        "options": {}
      },
      "id": "9b52d232-516d-430b-b07f-f9b14a5193cc",
      "name": "HU13 - Mensaje L√≠mite Alcanzado2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        4064,
        1952
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit?pli=1&gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "estado",
              "lookupValue": "=ACTIVA"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2160,
        2416
      ],
      "id": "2e0d72b9-50ef-4103-a2d5-771cc59f9f78",
      "name": "Obtener Preferencias1",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 808930077,
          "mode": "list",
          "cachedResultName": "LimitesReportes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=808930077"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $json.email }}",
            "limite": "={{$json.limite}}",
            "usados": "={{ $json.usados_nuevo }}",
            "actualizado_ts": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\")}}\n\n"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "limite",
              "displayName": "limite",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "usados",
              "displayName": "usados",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes",
              "displayName": "mes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "actualizado_ts",
              "displayName": "actualizado_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "key",
              "displayName": "key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f38223a1-28e5-42e3-a24c-33230e2eb1be",
      "name": "HU13 - Incrementar Consumo2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4688,
        3264
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 51153146,
          "mode": "list",
          "cachedResultName": "CantReporte",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=51153146"
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}\n"
            },
            {
              "fieldId": "email",
              "fieldValue": "=  {{ $('Split In Batches').first().json.email }}"
            },
            {
              "fieldId": "tipo",
              "fieldValue": "=Programado"
            }
          ]
        },
        "options": {}
      },
      "id": "7e042087-3c84-47a5-a7e8-de53bd99bf44",
      "name": "HU7 - Registrar Consulta",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        3088,
        2784
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ================================================\n// Helpers\n// ================================================\nfunction normalize(s) {\n    return String(s || \"\")\n        .normalize(\"NFD\")\n        .replace(/[\\u0300-\\u036f]/g, \"\")\n        .toLowerCase()\n        .trim();\n}\n\nfunction canonModa(s) {\n    const t = normalize(s);\n    if (!t) return \"\";\n    if (t.includes(\"remot\") || t.includes(\"teletrabajo\")) return \"remoto\";\n    if (t.includes(\"hibrid\") || t.includes(\"mixt\") || t.includes(\"semi\")) return \"hibrido\";\n    if (t.includes(\"presenc\") || t.includes(\"oficin\") || t.includes(\"onsite\")) return \"presencial\";\n    return \"\";\n}\n\n// Mapa de Regiones (Expandido con Maule y otras)\nconst REGION_MAP = {\n    \"region metropolitana\": [\"rm\", \"metropolitana\", \"santiago\", \"las condes\", \"providencia\", \"quilicura\", \"huechuraba\", \"maipu\", \"lampa\", \"colina\"],\n    \"region de valparaiso\": [\"region v\", \"valparaiso\", \"vi√±a\", \"quilpue\", \"villa alemana\"],\n    \"region del biobio\": [\"region viii\", \"concepcion\", \"bio bio\", \"b√≠o b√≠o\", \"talcahuano\"],\n    \"region de antofagasta\": [\"region ii\", \"antofagasta\", \"calama\"],\n    \"region del maule\": [\"region vii\", \"maule\", \"talca\", \"curico\", \"linares\"],\n    \"region de ohiggins\": [\"region vi\", \"rancagua\", \"ohiggins\", \"o'higgins\"],\n};\n\nfunction canonRegion(txt) {\n    const clean = normalize(txt);\n    for (const [std, aliases] of Object.entries(REGION_MAP)) {\n        if (clean.includes(std)) return std;\n        for (const a of aliases) {\n            if (clean.includes(a)) return std;\n        }\n    }\n    return clean; \n}\n\nfunction matchRegion(prefRegion, regionItem) {\n    // Si el usuario no pidi√≥ regi√≥n o dice \"todas\", pasa todo\n    if (!prefRegion || prefRegion === \"todas\" || prefRegion === \"no especificada\") return true;\n    \n    const rItem = canonRegion(regionItem);\n    const rPref = canonRegion(prefRegion);\n\n    // Coincidencia estricta o parcial\n    if (rItem === rPref) return true;\n    if (rItem.includes(rPref) || rPref.includes(rItem)) return true;\n\n    return false;\n}\n\n// ================================================\n// 1. Obtener preferencias (CORREGIDO AQU√ç)\n// ================================================\nlet prefRegion = \"\";\nlet prefModa = \"\";\n\ntry {\n    // ‚ö†Ô∏è CORRECCI√ìN: Usamos el nombre exacto de tu nodo \"Split In Batches\"\n    // Intentamos buscar \"Split In Batches\", si falla probamos con \"Split In Batches1\" por si acaso\n    let prefsNode = $('Split In Batches').first().json; \n    \n    // Fallback por si n8n le puso un n√∫mero autom√°ticamente\n    if (!prefsNode) try { prefsNode = $('Split In Batches1').first().json; } catch(e){}\n\n    const prefs = prefsNode || {};\n    \n    prefRegion = prefs.region || prefs.Regi√≥n || \"\";\n    prefModa = canonModa(prefs.modalidad || prefs.Modalidad || \"\");\n    \n} catch (e) {\n    console.log(\"Error leyendo preferencias: \", e.message);\n}\n\nconsole.log(`Usuario actual pide: Regi√≥n [${prefRegion}] - Modalidad [${prefModa}]`);\n\n// ================================================\n// 2. Clasificar ofertas\n// ================================================\nconst exactas = [];\nconst alternativas = [];\n\nfor (const item of items) {\n    const json = item.json;\n    if (!json.link) continue;\n\n    // Buscamos regi√≥n en 'region' o 'ubicacion'\n    const regionItem = json.region || json.ubicacion || \"\";\n    \n    // FILTRO DE REGI√ìN: Si no coincide, 'continue' (salta al siguiente)\n    if (!matchRegion(prefRegion, regionItem)) {\n        continue;\n    }\n\n    // Normalizamos modalidad de la oferta\n    const modaItem = canonModa(json.modalidad) || canonModa(json.region) || \"presencial\";\n\n    // L√≥gica de Modalidad\n    const coincideModa =\n        prefModa === \"\" || \n        prefModa === \"no especificada\" ||\n        prefModa === modaItem ||\n        (prefModa === \"remoto\" && modaItem === \"hibrido\");\n\n    if (coincideModa) {\n        exactas.push({ json: { ...json, modalidad: modaItem } });\n    } else {\n        alternativas.push({ json: { ...json, modalidad: modaItem } });\n    }\n}\n\n// ================================================\n// 3. RETORNO\n// ================================================\n\nif (exactas.length > 0) return exactas;\n\nif (alternativas.length > 0) {\n    return alternativas.map(item => ({\n        json: {\n            ...item.json,\n            aviso: `No hay ofertas ${prefModa}, mostrando ${item.json.modalidad}`\n        }\n    }));\n}\n\n// Si no hay nada para Maule, devolvemos un aviso vac√≠o para que el IF lo detecte\nreturn [{\n    json: {\n        msg: \"Sin coincidencias\",\n        prefRegion,\n        prefModa,\n        total_in: items.length\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3072,
        3168
      ],
      "id": "7b447525-6271-4d1d-9622-71db0ca4551c",
      "name": "HU3 - PrepararHistorial2",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1496762465,
          "mode": "list",
          "cachedResultName": "HistorialOfertas",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=1496762465"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp_reporte": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\") }}",
            "modalidad": "={{ $json.modalidad }}",
            "ubicacion": "={{ $json.region }}",
            "link": "={{ $json.link }}",
            "fuente ": "={{ $json.fuente }}",
            "titulo": "={{ $json.titulo }}",
            "empresa": "={{ $json.empresa }}",
            "Clave_unica": "={{ $json.titulo }} + {{ $json.empresa }}",
            "email": "={{ $('Split In Batches').first().json.email }}"
          },
          "matchingColumns": [
            "timestamp_reporte"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "timestamp_reporte",
              "displayName": "timestamp_reporte",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "fuente ",
              "displayName": "fuente ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "titulo",
              "displayName": "titulo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "empresa",
              "displayName": "empresa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ubicacion",
              "displayName": "ubicacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "modalidad",
              "displayName": "modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "link",
              "displayName": "link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Clave_unica",
              "displayName": "Clave_unica",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3584,
        3264
      ],
      "id": "2d8862a2-909e-4f1e-8513-883f0d268a0b",
      "name": "HU3 - Historial Ofertas",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos desde los nodos anteriores\nconst limiteRow = $items('HU13 - Get L√≠mite (HU6)1')[0].json;\nconst consumoRow = $items('HU13 - Get Consumo Actual1')[0].json;\nconst emailRow = $items('HU13 - Normalizar Email1')[0].json;\n\n// Convertir valores\nconst limite = Number(limiteRow.limite || 0);\nconst usados_actual = Number(consumoRow.usados || 0);\n\n// Incremento\nconst usados_nuevo = usados_actual + 1;\n\n// Mes actual YYYY-MM\nconst mes = new Date().toISOString().slice(0, 7);\n\n// Timestamp\nconst actualizado_ts = new Date().toISOString();\n\n// Devolver un √∫nico item limpio\nreturn [\n  {\n    email: emailRow.email,\n    limite,\n    usados_actual,\n    usados_nuevo,\n    mes,\n    actualizado_ts\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4512,
        3264
      ],
      "id": "17d18097-a6bf-4173-9036-30abf23b58ab",
      "name": "Incrementar Consumo HU"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Registro de Inscritos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Lzn7Q2zmv_7ZmR7RbtEe8sSHyciuNY_HlD28eOxyr3c/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Email": "={{ $('Send email4').item.json.accepted[0] }}",
            "next_run": "={{$json.next_run}}",
            "last_update": "={{ $now.toFormat(\"yyyy-LL-dd HH:mm:ss\")}}"
          },
          "matchingColumns": [
            "Email"
          ],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Apellido",
              "displayName": "Apellido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frecuencia",
              "displayName": "Frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Modalidad",
              "displayName": "Modalidad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Regi√≥n",
              "displayName": "Regi√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_run",
              "displayName": "next_run",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_update",
              "displayName": "last_update",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4272,
        3264
      ],
      "id": "f3f66b5b-7ca5-4390-9625-5051208290a6",
      "name": "Update next_run1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3ir3Blw8QjsXap0a",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/customsearch/v1",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "AIzaSyAj3XZnU3uJGQvAZgcqjIFAARoKYB2NO7Y"
            },
            {
              "name": "cx",
              "value": "63640653858d34b46"
            },
            {
              "name": "q",
              "value": "practica informatica computrabajo"
            },
            {
              "name": "num",
              "value": "10"
            },
            {
              "name": "lr",
              "value": "lang_es"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4640,
        2704
      ],
      "id": "8ec98ef6-7e50-4a02-af9e-7641df8375c8",
      "name": "HTTP Request2",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// `items` es el array que entra al Code node desde el HTTP Request\nconst salida = [];\n\nfor (const item of items) {\n  // Aqu√≠ est√° el JSON completo que te mostr√≥ el HTTP Node\n  const respuesta = item.json;\n\n  // De ah√≠ sacamos el arreglo `items` de Google CSE\n  const resultados = respuesta.items || [];\n\n  for (const r of resultados) {\n    salida.push({\n      json: {\n        title: r.title,\n        url: r.link\n      }\n    });\n  }\n}\n\nreturn salida;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4992,
        2704
      ],
      "id": "71ec1d4d-d8a2-46f2-8ae6-f3be5c73de4f",
      "name": "Code in JavaScript5",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bf79c74d-9b01-4476-81be-de9447c4500b",
              "leftValue": "={{ $json.no_results_historial }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3264,
        3168
      ],
      "id": "e5e62b73-fe7c-4a96-b3be-10819985b9fe",
      "name": "If3"
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Split In Batches').first().json.email}}",
        "subject": "No se encontraron ofertas de pr√°ctica",
        "html": "=  <p>üëã Hola {{ $('Split In Batches').first().json.nombre }},</p>\n\n<p>No se encontraron ofertas de pr√°ctica que coincidan con tus preferencias en esta ejecuci√≥n.</p>\n\n<p>Esto puede deberse a que:</p>\n<ul>\n  <li>No hubo publicaciones nuevas en las plataformas consultadas.</li>\n  <li>No existieron ofertas que coincidieran con tu regi√≥n o modalidad seleccionada.</li>\n  <li>Las fuentes revisadas (Indeed, Laborum, otras) no devolvieron resultados v√°lidos.</li>\n</ul>\n\n<p>El sistema seguir√° buscando autom√°ticamente seg√∫n tu frecuencia configurada.</p>\n\n<hr>\n<p style=\"font-size:12px;color:#888;\">\n  Sistema automatizado ‚Äì Buscador de Pr√°cticas de Inform√°tica<br>\n  No respondas a este correo.\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        3568,
        3008
      ],
      "id": "02352723-0eae-43ee-94b4-e8edb7b75a11",
      "name": "Send email5",
      "webhookId": "7a8d1d54-0ce0-42b2-a5b8-9e16c9b1a570",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "buscador.practicasinformatica@gmail.com",
        "toEmail": "={{ $('Split In Batches').item.json.email }}",
        "subject": "L√≠mite Alcanzado ",
        "html": "=<p>Hola üëã</p>\n\n<p><strong>Has alcanzado tu l√≠mite mensual de reportes inmediatos.</strong></p>\n\n<p>\nHemos recibido tu solicitud de reporte ahora, pero actualmente ya utilizaste todos los reportes disponibles para este mes.\n</p>\n\n<p>\nTendr√°s nuevos cupos autom√°ticamente el d√≠a:\n</p>\n\n<p style=\"font-size: 16px; font-weight: bold; margin: 8px 0;\">\n  \n</p>\n\n<p>\nRecuerda que el sistema permite un n√∫mero limitado de reportes instant√°neos cada mes para asegurar un servicio estable para todos los usuarios.\n</p>\n\n<p>\nMientras tanto, puedes seguir recibiendo tus reportes programados seg√∫n tu frecuencia actual, o modificar tus preferencias cuando lo necesites.\n</p>\n\n<p>\nSi tienes dudas o necesitas asistencia, no dudes en responder este correo.\n</p>\n\n<hr>\n<p style=\"font-size: 12px; color: #888;\">\nSistema Automatizado ‚Äì Proyecto de Pr√°ctica Inform√°tica<br>\nUniversidad Andr√©s Bello ¬∑ n8n\n</p>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        4304,
        1952
      ],
      "id": "b6c8afad-e5fb-4a02-a936-2572696a1fa0",
      "name": "limite2",
      "webhookId": "bb608e3e-309e-442d-a2c7-151be37fd40d",
      "credentials": {
        "smtp": {
          "id": "pN6T8YGU9dLjzt07",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "allowUnauthorizedCerts": true,
        "responseFormat": "string",
        "options": {
          "followAllRedirects": true,
          "ignoreResponseCode": true
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)              AppleWebKit/537.36 (KHTML, like Gecko)              Chrome/118.0.5993.118 Safari/537.36"
            },
            {
              "name": "Accept-Language",
              "value": "es-CL,es;q=0.9,en;q=0.8"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            },
            {
              "name": "Cookie",
              "value": "ONSENT=YES+1"
            }
          ]
        }
      },
      "id": "283af0f9-6c78-44c5-b91b-599c70a75e05",
      "name": "HTTP 2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        5360,
        2928
      ],
      "retryOnFail": true,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "extractHtmlContent",
        "extractionValues": {
          "values": [
            {
              "key": "titulo",
              "cssSelector": "h2.fs18 a.js-o-link"
            },
            {
              "key": "link",
              "cssSelector": "h2.fs18 a.js-o-link",
              "returnValue": "attribute",
              "attribute": "href"
            },
            {
              "key": "empresa",
              "cssSelector": "p.dFlex.vm_fx.fs16.fc_base.mt5"
            },
            {
              "key": "ubicacion",
              "cssSelector": "p.fs16.fc_base.mt5:not(.dFlex)"
            },
            {
              "key": "modalidad",
              "cssSelector": "div.fs13.mt15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        5776,
        2928
      ],
      "id": "7495c0c6-3bd9-4818-a121-8a0fe7c1df5e",
      "name": "HTML2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const regionMap = {\n  \"R.Metropolitana\": \"Regi√≥n Metropolitana\",\n  \"Metropolitana\": \"Regi√≥n Metropolitana\",\n  \"Santiago\": \"Regi√≥n Metropolitana\",\n  \"Valpara√≠so\": \"Regi√≥n de Valpara√≠so\",\n  \"Biob√≠o\": \"Regi√≥n del Biob√≠o\",\n  \"Antofagasta\": \"Regi√≥n de Antofagasta\",\n  \"Coquimbo\": \"Regi√≥n de Coquimbo\",\n  \"O'Higgins\": \"Regi√≥n del Libertador General Bernardo O'Higgins\",\n  \"Maule\": \"Regi√≥n del Maule\",\n  \"√ëuble\": \"Regi√≥n de √ëuble\",\n  \"Araucan√≠a\": \"Regi√≥n de La Araucan√≠a\",\n  \"Los Lagos\": \"Regi√≥n de Los Lagos\",\n  \"Los R√≠os\": \"Regi√≥n de Los R√≠os\",\n  \"Ays√©n\": \"Regi√≥n de Ays√©n\",\n  \"Magallanes\": \"Regi√≥n de Magallanes\",\n};\n\nfunction normalizarRegion(texto) {\n  if (!texto) return \"Sin regi√≥n\";\n  let limpio = texto.replace(/\\n/g, \"\").replace(/\\s+/g, \" \").trim();\n  \n  // Seguridad anti-n√∫meros (para que no se cuele un \"4.4\")\n  if (/^\\d+([,.]\\d+)?$/.test(limpio) || limpio.length < 3) return \"Sin regi√≥n\";\n\n  const partes = limpio.split(/[,-]/);\n  for (let i = partes.length - 1; i >= 0; i--) {\n    const fragmento = partes[i].trim();\n    if (regionMap[fragmento]) return regionMap[fragmento];\n  }\n  const ultimoFragmento = partes[partes.length - 1].trim();\n  return regionMap[ultimoFragmento] || ultimoFragmento;\n}\n\nreturn items.map(item => {\n  const datos = item.json;\n\n  // 1. LIMPIEZA DE EMPRESA (Correcci√≥n aplicada aqu√≠)\n  let empresa = (datos.empresa || \"\")\n    .replace(/\\n/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .replace(/\\[.*?\\]/g, \"\") // <--- BORRA LO QUE EST√Å ENTRE CORCHETES [http...]\n    .replace(/https?:\\/\\/\\S+/g, \"\") // <--- BORRA URLs SUELTAS\n    .trim();\n\n  // Borrar nota si viene al principio (ej: \"4,4 Perceptual...\")\n  empresa = empresa.replace(/^\\d+([,.]\\d+)?\\s*/, \"\"); \n\n  // 2. Separaci√≥n SUELDO / MODALIDAD\n  let infoRaw = (datos.info_extra || \"\").replace(/\\n/g, \" \").replace(/\\s+/g, \" \").trim();\n  let sueldo = \"No especificado\";\n  let modalidad = \"Presencial\"; \n\n  if (infoRaw.includes(\"$\")) {\n    const matchSueldo = infoRaw.match(/(\\$[\\s\\d.,]+(\\(Mensual\\))?)/i);\n    if (matchSueldo) {\n      sueldo = matchSueldo[0].trim();\n      infoRaw = infoRaw.replace(sueldo, \"\");\n    }\n  }\n\n  const textoLower = infoRaw.toLowerCase();\n  if (textoLower.includes(\"remoto\") && textoLower.includes(\"presencial\")) modalidad = \"H√≠brido/Mixto\";\n  else if (textoLower.includes(\"remoto\") || textoLower.includes(\"teletrabajo\")) modalidad = \"Remoto\";\n  else if (textoLower.includes(\"h√≠brido\") || textoLower.includes(\"hibrido\")) modalidad = \"H√≠brido\";\n  \n  // 3. Ubicaci√≥n y Links\n  let ubicacionRaw = datos.ubicacion || \"\";\n  if (/^\\d+([,.]\\d+)?$/.test(ubicacionRaw.trim())) ubicacionRaw = \"\"; // Anti-n√∫meros\n  \n  const ubicacionLimpia = ubicacionRaw.replace(/\\n/g, \"\").replace(/\\s+/g, \" \").trim();\n\n  let link = datos.link || \"\";\n  if (link && !link.startsWith(\"http\")) link = \"https://cl.computrabajo.com\" + link;\n\n  return {\n    json: {\n      fuente: \"Computrabajo\",\n      titulo: (datos.titulo || \"\").trim(),\n      empresa: empresa, // Ahora saldr√° limpia: \"Perceptual Consultores Ltda.\"\n      sueldo: sueldo,\n      ubicacion: ubicacionLimpia,\n      region: normalizarRegion(ubicacionLimpia),\n      modalidad: modalidad,\n      link,\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5920,
        2928
      ],
      "id": "13e44f35-6b54-4cf6-b447-23f3a97553cb",
      "name": "Code in JavaScript13"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        5232,
        2672
      ],
      "id": "f7f9644f-4510-4ca8-90e0-338d8f25af03",
      "name": "Loop Over Items2"
    },
    {
      "parameters": {
        "jsCode": "// Agregar Resultados  (MODO: Run Once for All Items)\n\nconst unicos = [];\nconst vistos = new Set();\n\n// Aqu√≠ usamos lo que llega por la salida \"done\" del Loop Over Items\n// Es decir, TODOS los resultados de Code in JavaScript10 ya combinados.\nfor (const item of $input.all()) {\n  const dato = item.json || {};\n\n  // Solo agregamos si tiene link y no lo hemos visto antes\n  if (dato.link && !vistos.has(dato.link)) {\n    vistos.add(dato.link);\n    unicos.push({ json: dato });\n  }\n}\n\n// Por si quieres ver en consola cu√°ntos quedaron:\nconsole.log(`Ofertas Computrabajo √∫nicas: ${unicos.length}`);\n\nreturn unicos;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5440,
        2576
      ],
      "id": "51d58ab5-07ed-4faa-b534-cbc9d954fe89",
      "name": "Agregar Resultados2"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/customsearch/v1",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "AIzaSyAj3XZnU3uJGQvAZgcqjIFAARoKYB2NO7Y"
            },
            {
              "name": "cx",
              "value": "63640653858d34b46"
            },
            {
              "name": "q",
              "value": "site:firstjob.me \"pr√°ctica\" inform√°tica"
            },
            {
              "name": "dateRestrict",
              "value": "w1"
            },
            {
              "name": "gl",
              "value": "cl"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {}
      },
      "id": "78f346ff-0aef-4850-b683-f760d263f3be",
      "name": "Google Search (FirstJob)1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4912,
        2064
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const salida = [];\n\nfor (const item of items) {\n  const json = item.json;\n  \n  // Si Google devolvi√≥ un error expl√≠cito\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n      // No hacemos nada aqu√≠, dejaremos que el bloque final lance el error\n  } else {\n      const resultados = json.items || [];\n      for (const r of resultados) {\n        salida.push({ json: { link: r.link } });\n      }\n  }\n}\n\n// --- EL SALVAVIDAS (Esto faltaba) ---\n// Si la lista est√° vac√≠a, asumimos que hubo un error o no hay datos.\n// Pasamos un objeto de error para que el flujo NO se detenga.\nif (salida.length === 0) {\n    return [{\n        json: {\n            es_error: true,\n            fuente: \"FirstJob\",\n            mensaje: \"Error de API Google o Sin Resultados\",\n            link: \"ERROR_FIRSTJOB\" // Necesario para el deduplicador\n        }\n    }];\n}\n\nreturn salida;"
      },
      "id": "742e9c43-d7f0-44b6-b2f1-0686ebd57e28",
      "name": "Prep Links FJ1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5296,
        2064
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "={{ $json.link }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "id": "922b9fb0-8025-4b41-98db-672733b10b67",
      "name": "HTTP FirstJob1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        5504,
        2064
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "extractHtmlContent",
        "extractionValues": {
          "values": [
            {
              "key": "og_title",
              "cssSelector": "meta[property=\\\"og:title\\\"]",
              "returnValue": "attribute",
              "attribute": "content"
            },
            {
              "key": "og_desc",
              "cssSelector": "meta[property=\\\"og:description\\\"]",
              "returnValue": "attribute",
              "attribute": "content"
            },
            {
              "key": "json_ld",
              "cssSelector": "script[type=\\\"application/ld+json\\\"]"
            },
            {
              "key": "h1_title",
              "cssSelector": "h1"
            },
            {
              "key": "page_title",
              "cssSelector": "title"
            }
          ]
        },
        "options": {}
      },
      "id": "f8ac1a31-38f2-4442-8ede-4f8c470ed1f2",
      "name": "HTML FirstJob1",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [
        5728,
        2064
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// --- 1. PASE VIP PARA ERRORES (Al principio de todo) ---\n// Si llega el objeto de error que creamos en el nodo anterior, lo dejamos pasar.\nconst primerItem = items[0] ? items[0].json : {};\n\nif (primerItem.es_error) {\n    return [{\n        json: {\n            fuente: \"FirstJob\",\n            es_error: true,\n            mensaje: \"Problema al consultar Google/FirstJob\",\n            link: \"ERROR_FIRSTJOB\"\n        }\n    }];\n}\n\n// --- C√ìDIGO NORMAL (Si son ofertas reales) ---\nconst linksOriginales = $('Prep Links FJ1').all(); \nconst empresasVIP = [\"Walmart\", \"Nestl√©\", \"AFP Capital\", \"Cencosud\", \"Falabella\", \"Banco de Chile\", \"Streat Food\", \"Arcoprime\", \"KPMG\", \"SGS\", \"Nubox\", \"Transbank\", \"Enel\", \"Codelco\"];\n\nreturn items.map((item, i) => {\n  const datos = item.json;\n  \n  // Recuperar Datos\n  let rawTitle = datos.og_title || datos.h1_title || datos.page_title || \"\";\n  let rawDesc  = datos.og_desc || \"\";\n  let empresa  = \"Empresa Confidencial\";\n  \n  // JSON-LD\n  if (datos.json_ld) {\n      try {\n          const jsonLimpio = JSON.parse(datos.json_ld);\n          if (jsonLimpio.hiringOrganization && jsonLimpio.hiringOrganization.name) {\n              empresa = jsonLimpio.hiringOrganization.name;\n          } else if (Array.isArray(jsonLimpio)) {\n              const job = jsonLimpio.find(o => o['@type'] === 'JobPosting');\n              if (job && job.hiringOrganization) empresa = job.hiringOrganization.name;\n          }\n      } catch (e) {}\n  }\n\n  // Limpieza T√≠tulo\n  let titulo = rawTitle\n    .replace(/\\(ID:\\s*\\d+\\)/i, \"\") \n    .replace(/\\s*-\\s*Pr√°ctica, Pasant√≠a, Internship y Primeros Trabajos/ig, \"\")\n    .replace(/\\|\\s*FirstJob/i, \"\")\n    .replace(/\\-\\s*FirstJob/i, \"\")\n    .replace(/FirstJob/i, \"\")\n    .replace(/([\\u2700-\\u27BF]|[\\uE000-\\uF8FF]|\\uD83C[\\uDC00-\\uDFFF]|\\uD83D[\\uDC00-\\uDFFF])/g, '')\n    .trim();\n\n  // Detective Empresa\n  if (empresa === \"Empresa Confidencial\") {\n      let textoGigante = (titulo + \" \" + rawDesc).toLowerCase();\n      for (const vip of empresasVIP) {\n          if (textoGigante.includes(vip.toLowerCase())) {\n              empresa = vip;\n              break;\n          }\n      }\n      if (empresa === \"Empresa Confidencial\" && rawDesc) {\n        const match = rawDesc.match(/(?:en|parte de|somos|equipo de|invita a)\\s+([A-Z√Å√â√ç√ì√ö0-9][a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö\\s\\.\\-]+?)(?:,|\\.|!|y\\s|que\\s|\\sbuscamos|\\ste\\s)/);\n        if (match && match[1]) {\n           let nombreCapturado = match[1].trim();\n           if (nombreCapturado.length < 35 && nombreCapturado.length > 2 && !nombreCapturado.toLowerCase().includes(\"pr√°ctica\")) {\n             empresa = nombreCapturado;\n           }\n        }\n      }\n  }\n\n  // Modalidad y Regi√≥n\n  let textoAnalisis = (titulo + \" \" + rawDesc).toLowerCase();\n  let modalidad = \"Presencial\"; \n  if (textoAnalisis.includes(\"remoto\")) modalidad = \"Remoto\";\n  else if (textoAnalisis.includes(\"h√≠brido\") || textoAnalisis.includes(\"hibrido\")) modalidad = \"H√≠brido\";\n\n  let region = \"Regi√≥n Metropolitana\"; \n  if (textoAnalisis.includes(\"valpara√≠so\") || textoAnalisis.includes(\"vi√±a\")) region = \"Regi√≥n de Valpara√≠so\";\n  else if (textoAnalisis.includes(\"biob√≠o\") || textoAnalisis.includes(\"concepci√≥n\")) region = \"Regi√≥n del Biob√≠o\";\n  else if (textoAnalisis.includes(\"antofagasta\")) region = \"Regi√≥n de Antofagasta\";\n\n  let link = linksOriginales[i]?.json?.link || \"https://firstjob.me\";\n\n  return {\n    json: {\n      fuente: \"FirstJob\",\n      titulo,\n      empresa, \n      region,\n      ubicacion: region,\n      modalidad,\n      link\n    }\n  };\n})\n.filter(item => {\n    // Filtro final: Si es una oferta real, debe tener t√≠tulo v√°lido\n    const t = item.json.titulo;\n    return t && t.length > 5 && !t.includes(\"Pr√°ctica, Pasant√≠a\");\n});"
      },
      "id": "ad6ea39a-03e7-423a-a6b1-b38fa221c6c8",
      "name": "Parse FirstJob1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6272,
        2064
      ]
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6768,
        3040
      ],
      "id": "0689677c-55bc-40ec-b9c5-1d09ab030c8e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Laborum\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5216,
        2336
      ],
      "id": "97bb6bd7-37ca-4692-bcb3-58d6ae412b40",
      "name": "Normalizar Respuesta Fuente"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"FirstJob\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5104,
        2064
      ],
      "id": "cfcfee6e-b293-42cc-813d-01e4ec3d469c",
      "name": "Normalizar Respuesta Fuente1"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"FirstJob\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5984,
        2064
      ],
      "id": "00bfbb7e-63ad-430e-af8e-bd3c42ea4d68",
      "name": "Normalizar Respuesta Fuente2"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Computrabajo\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4768,
        2672
      ],
      "id": "d90f2553-f256-46d0-99b1-91cfec1a3b4d",
      "name": "Normalizar Respuesta Fuente3"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Computrabajo\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5568,
        2928
      ],
      "id": "4fd2e94c-4ade-4603-bb7e-9a404db8607b",
      "name": "Normalizar Respuesta Fuente4"
    },
    {
      "parameters": {
        "jsCode": "// PARSER LABORUM ‚Äì Con \"Pase de Error\"\n\nconst item = items[0].json;\n\n// --- 1. DETECCI√ìN DE ERROR (¬°Esto es lo que faltaba!) ---\n// Si el nodo HTTP anterior fall√≥, n8n suele mandar un campo 'error' o 'statusCode' malo.\nif (item.error || (item.statusCode && item.statusCode >= 400)) {\n    // ¬°Es un error! No intentamos parsear. Pasamos la alerta roja.\n    return [{\n        json: {\n            fuente: \"Laborum\",\n            es_error: true, // Esta es la bandera que activa la caja roja\n            codigo: item.statusCode || 500,\n            mensaje: \"Error de conexi√≥n o p√°gina no encontrada (Simulado)\"\n        }\n    }];\n}\n\n// --- 2. EXTRACCI√ìN DE CONTENIDO ---\nconst rawData = item.data || item.content || \"\";\n// Convertimos a texto por si acaso llega un objeto raro\nconst raw = typeof rawData === 'object' ? JSON.stringify(rawData) : String(rawData);\n\nconst text = raw.includes(\"Markdown Content:\") \n  ? raw.split(\"Markdown Content:\")[1] \n  : raw;\n\n// --- 3. L√ìGICA DE B√öSQUEDA (Tu c√≥digo original) ---\nconst regex = /\\[([\\s\\S]*?)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g;\n\nfunction limpiarEspacios(s) {\n  return String(s || \"\").replace(/\\n+/g, \" \").replace(/\\s+/g, \" \").trim();\n}\n\nconst ofertas = [];\n\nwhile (true) {\n  const m = regex.exec(text);\n  if (!m) break;\n\n  let inside = m[1];\n  const url  = m[2].trim();\n\n  if (/\\.(jpg|jpeg|png|gif)(\\?|$)/i.test(url)) continue;\n\n  inside = limpiarEspacios(inside);\n  let segments = inside.split(\"###\").map(limpiarEspacios).filter(s => s && !s.startsWith(\"![Image\"));\n\n  if (!segments.length) continue;\n\n  let tituloRaw = segments.find(s => /Pr[a√°]ctica|Alumno/i.test(s)) || segments[0];\n  const matchTitulo = tituloRaw.match(/(Pr[a√°]ctica|Alumno[a]? en Pr[a√°]ctica)[^#]+/i);\n  let titulo = (matchTitulo ? matchTitulo[0] : tituloRaw).replace(/-{2,}.*$/, \"\").trim();\n  titulo = titulo.replace(/^\\s*(m√°s de\\s+\\d+\\s+d[i√≠]as?|[\\d.,]+\\s*(horas?|d[i√≠]as?))\\s+/i, \"\");\n\n  let empresaSeg = segments[1] || \"\";\n  if (/^(Publicado|Actualizado)/i.test(empresaSeg)) empresaSeg = \"\";\n  \n  const idxEn = empresaSeg.search(/\\sEn\\s/i);\n  if (idxEn > 0) empresaSeg = empresaSeg.slice(0, idxEn);\n  const punto = empresaSeg.indexOf(\".\");\n  if (punto > 0) empresaSeg = empresaSeg.slice(0, punto);\n\n  let empresa = limpiarEspacios(empresaSeg);\n  if (!empresa) empresa = \"Sin empresa\";\n\n  const regionCandidates = segments.filter(s => /Regi√≥n|Region/i.test(s));\n  let region = \"Sin regi√≥n\";\n  if (regionCandidates.length) {\n    regionCandidates.sort((a, b) => a.length - b.length);\n    region = limpiarEspacios(regionCandidates[0]);\n  }\n\n  let modaSeg = [...segments].reverse().find(s => /Presencial|H√≠brido|Hibrido|Remoto|Teletrabajo|Mixta/i.test(s)) || \"\";\n  let modalidad = \"Presencial\";\n  const mNorm = modaSeg.toLowerCase();\n  if (mNorm.includes(\"remoto\")) modalidad = \"Remoto\";\n  else if (mNorm.includes(\"h√≠brido\")) modalidad = \"H√≠brido\";\n\n  ofertas.push({\n    json: {\n      fuente: \"Laborum\",\n      titulo,\n      empresa,\n      region,\n      modalidad,\n      link: url,\n    },\n  });\n}\n\n// Si no hay ofertas pero tampoco era un error t√©cnico, devolvemos array vac√≠o\n// (El Build HTML se encargar√° de decir \"No hay resultados\")\nif (!ofertas.length) return [];\n\nreturn ofertas;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6112,
        2544
      ],
      "id": "70dbdece-6c89-412b-850b-804cbd82c200",
      "name": "parser laborum",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "https://r.jina.ai/https://www.laborum.cl/empleos-busqueda-practica-informatica.html",
        "allowUnauthorizedCerts": true,
        "responseFormat": "string",
        "jsonParameters": true,
        "options": {
          "followAllRedirects": true,
          "ignoreResponseCode": true
        },
        "headerParametersJson": "{\n  \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0\",\n  \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\",\n  \"Accept-Language\": \"es-CL,es;q=0.9\",\n  \"Accept-Encoding\": \"gzip, deflate, br\",\n  \"Connection\": \"keep-alive\",\n  \"Upgrade-Insecure-Requests\": \"1\",\n  \"Cache-Control\": \"no-cache\",\n  \"Pragma\": \"no-cache\"\n}\n"
      },
      "id": "97ef7153-bbb5-42b4-a29b-ada0049ab4c6",
      "name": "HTTP Laborum (placeholder)3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        -2976,
        1936
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/customsearch/v1",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "AIzaSyAj3XZnU3uJGQvAZgcqjIFAARoKYB2NO7Y"
            },
            {
              "name": "cx",
              "value": "63640653858d34b46"
            },
            {
              "name": "q",
              "value": "practica informatica computrabajo"
            },
            {
              "name": "num",
              "value": "10"
            },
            {
              "name": "lr",
              "value": "lang_es"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3216,
        2336
      ],
      "id": "aefc9ec6-9618-4094-8632-3db5959fd0c6",
      "name": "HTTP Request",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// `items` es el array que entra al Code node desde el HTTP Request\nconst salida = [];\n\nfor (const item of items) {\n  // Aqu√≠ est√° el JSON completo que te mostr√≥ el HTTP Node\n  const respuesta = item.json;\n\n  // De ah√≠ sacamos el arreglo `items` de Google CSE\n  const resultados = respuesta.items || [];\n\n  for (const r of resultados) {\n    salida.push({\n      json: {\n        title: r.title,\n        url: r.link\n      }\n    });\n  }\n}\n\nreturn salida;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        2336
      ],
      "id": "27e91266-c950-440f-be55-fec9e0f8b2ef",
      "name": "Code in JavaScript6",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "allowUnauthorizedCerts": true,
        "responseFormat": "string",
        "options": {
          "followAllRedirects": true,
          "ignoreResponseCode": true
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)              AppleWebKit/537.36 (KHTML, like Gecko)              Chrome/118.0.5993.118 Safari/537.36"
            },
            {
              "name": "Accept-Language",
              "value": "es-CL,es;q=0.9,en;q=0.8"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            },
            {
              "name": "Cookie",
              "value": "ONSENT=YES+1"
            }
          ]
        }
      },
      "id": "ea6a5040-7d74-4bc0-8b4d-325c6e944340",
      "name": "HTTP ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        -2496,
        2560
      ],
      "retryOnFail": true,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "extractHtmlContent",
        "extractionValues": {
          "values": [
            {
              "key": "titulo",
              "cssSelector": "h2.fs18 a.js-o-link"
            },
            {
              "key": "link",
              "cssSelector": "h2.fs18 a.js-o-link",
              "returnValue": "attribute",
              "attribute": "href"
            },
            {
              "key": "empresa",
              "cssSelector": "p.dFlex.vm_fx.fs16.fc_base.mt5"
            },
            {
              "key": "ubicacion",
              "cssSelector": "p.fs16.fc_base.mt5:not(.dFlex)"
            },
            {
              "key": "modalidad",
              "cssSelector": "div.fs13.mt15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -2080,
        2560
      ],
      "id": "2fd3e03c-a1a6-4201-82c3-22c9db9e9acd",
      "name": "HTML",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const regionMap = {\n  \"R.Metropolitana\": \"Regi√≥n Metropolitana\",\n  \"Metropolitana\": \"Regi√≥n Metropolitana\",\n  \"Santiago\": \"Regi√≥n Metropolitana\",\n  \"Valpara√≠so\": \"Regi√≥n de Valpara√≠so\",\n  \"Biob√≠o\": \"Regi√≥n del Biob√≠o\",\n  \"Antofagasta\": \"Regi√≥n de Antofagasta\",\n  \"Coquimbo\": \"Regi√≥n de Coquimbo\",\n  \"O'Higgins\": \"Regi√≥n del Libertador General Bernardo O'Higgins\",\n  \"Maule\": \"Regi√≥n del Maule\",\n  \"√ëuble\": \"Regi√≥n de √ëuble\",\n  \"Araucan√≠a\": \"Regi√≥n de La Araucan√≠a\",\n  \"Los Lagos\": \"Regi√≥n de Los Lagos\",\n  \"Los R√≠os\": \"Regi√≥n de Los R√≠os\",\n  \"Ays√©n\": \"Regi√≥n de Ays√©n\",\n  \"Magallanes\": \"Regi√≥n de Magallanes\",\n};\n\nfunction normalizarRegion(texto) {\n  if (!texto) return \"Sin regi√≥n\";\n  let limpio = texto.replace(/\\n/g, \"\").replace(/\\s+/g, \" \").trim();\n  \n  // Seguridad anti-n√∫meros (para que no se cuele un \"4.4\")\n  if (/^\\d+([,.]\\d+)?$/.test(limpio) || limpio.length < 3) return \"Sin regi√≥n\";\n\n  const partes = limpio.split(/[,-]/);\n  for (let i = partes.length - 1; i >= 0; i--) {\n    const fragmento = partes[i].trim();\n    if (regionMap[fragmento]) return regionMap[fragmento];\n  }\n  const ultimoFragmento = partes[partes.length - 1].trim();\n  return regionMap[ultimoFragmento] || ultimoFragmento;\n}\n\nreturn items.map(item => {\n  const datos = item.json;\n\n  // 1. LIMPIEZA DE EMPRESA (Correcci√≥n aplicada aqu√≠)\n  let empresa = (datos.empresa || \"\")\n    .replace(/\\n/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .replace(/\\[.*?\\]/g, \"\") // <--- BORRA LO QUE EST√Å ENTRE CORCHETES [http...]\n    .replace(/https?:\\/\\/\\S+/g, \"\") // <--- BORRA URLs SUELTAS\n    .trim();\n\n  // Borrar nota si viene al principio (ej: \"4,4 Perceptual...\")\n  empresa = empresa.replace(/^\\d+([,.]\\d+)?\\s*/, \"\"); \n\n  // 2. Separaci√≥n SUELDO / MODALIDAD\n  let infoRaw = (datos.info_extra || \"\").replace(/\\n/g, \" \").replace(/\\s+/g, \" \").trim();\n  let sueldo = \"No especificado\";\n  let modalidad = \"Presencial\"; \n\n  if (infoRaw.includes(\"$\")) {\n    const matchSueldo = infoRaw.match(/(\\$[\\s\\d.,]+(\\(Mensual\\))?)/i);\n    if (matchSueldo) {\n      sueldo = matchSueldo[0].trim();\n      infoRaw = infoRaw.replace(sueldo, \"\");\n    }\n  }\n\n  const textoLower = infoRaw.toLowerCase();\n  if (textoLower.includes(\"remoto\") && textoLower.includes(\"presencial\")) modalidad = \"H√≠brido/Mixto\";\n  else if (textoLower.includes(\"remoto\") || textoLower.includes(\"teletrabajo\")) modalidad = \"Remoto\";\n  else if (textoLower.includes(\"h√≠brido\") || textoLower.includes(\"hibrido\")) modalidad = \"H√≠brido\";\n  \n  // 3. Ubicaci√≥n y Links\n  let ubicacionRaw = datos.ubicacion || \"\";\n  if (/^\\d+([,.]\\d+)?$/.test(ubicacionRaw.trim())) ubicacionRaw = \"\"; // Anti-n√∫meros\n  \n  const ubicacionLimpia = ubicacionRaw.replace(/\\n/g, \"\").replace(/\\s+/g, \" \").trim();\n\n  let link = datos.link || \"\";\n  if (link && !link.startsWith(\"http\")) link = \"https://cl.computrabajo.com\" + link;\n\n  return {\n    json: {\n      fuente: \"Computrabajo\",\n      titulo: (datos.titulo || \"\").trim(),\n      empresa: empresa, // Ahora saldr√° limpia: \"Perceptual Consultores Ltda.\"\n      sueldo: sueldo,\n      ubicacion: ubicacionLimpia,\n      region: normalizarRegion(ubicacionLimpia),\n      modalidad: modalidad,\n      link,\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1936,
        2560
      ],
      "id": "8401c30b-0e12-40e5-973a-98239f525dd4",
      "name": "Code in JavaScript14"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2624,
        2304
      ],
      "id": "991aee31-9a52-469f-b73d-065ee82093ee",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "jsCode": "// Agregar Resultados  (MODO: Run Once for All Items)\n\nconst unicos = [];\nconst vistos = new Set();\n\n// Aqu√≠ usamos lo que llega por la salida \"done\" del Loop Over Items\n// Es decir, TODOS los resultados de Code in JavaScript10 ya combinados.\nfor (const item of $input.all()) {\n  const dato = item.json || {};\n\n  // Solo agregamos si tiene link y no lo hemos visto antes\n  if (dato.link && !vistos.has(dato.link)) {\n    vistos.add(dato.link);\n    unicos.push({ json: dato });\n  }\n}\n\n// Por si quieres ver en consola cu√°ntos quedaron:\nconsole.log(`Ofertas Computrabajo √∫nicas: ${unicos.length}`);\n\nreturn unicos;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2416,
        2208
      ],
      "id": "0e3822dd-f3d0-4807-8ff0-47f73398db62",
      "name": "Agregar Resultados"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/customsearch/v1",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "AIzaSyAj3XZnU3uJGQvAZgcqjIFAARoKYB2NO7Y"
            },
            {
              "name": "cx",
              "value": "63640653858d34b46"
            },
            {
              "name": "q",
              "value": "site:firstjob.me \"pr√°ctica\" inform√°tica"
            },
            {
              "name": "dateRestrict",
              "value": "w1"
            },
            {
              "name": "gl",
              "value": "cl"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {}
      },
      "id": "0807733f-a195-4886-b6c9-5c8b089899a4",
      "name": "Google Search (FirstJob)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2944,
        1696
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const salida = [];\n\nfor (const item of items) {\n  const json = item.json;\n  \n  // Si Google devolvi√≥ un error expl√≠cito\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n      // No hacemos nada aqu√≠, dejaremos que el bloque final lance el error\n  } else {\n      const resultados = json.items || [];\n      for (const r of resultados) {\n        salida.push({ json: { link: r.link } });\n      }\n  }\n}\n\n// --- EL SALVAVIDAS (Esto faltaba) ---\n// Si la lista est√° vac√≠a, asumimos que hubo un error o no hay datos.\n// Pasamos un objeto de error para que el flujo NO se detenga.\nif (salida.length === 0) {\n    return [{\n        json: {\n            es_error: true,\n            fuente: \"FirstJob\",\n            mensaje: \"Error de API Google o Sin Resultados\",\n            link: \"ERROR_FIRSTJOB\" // Necesario para el deduplicador\n        }\n    }];\n}\n\nreturn salida;"
      },
      "id": "e2bced77-4c2b-45ed-9c87-338aab817908",
      "name": "Prep Links FJ2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2560,
        1696
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "={{ $json.link }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "id": "06099206-bbba-4839-8ea5-243a747ae2fb",
      "name": "HTTP FirstJob2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -2352,
        1696
      ],
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "extractHtmlContent",
        "extractionValues": {
          "values": [
            {
              "key": "og_title",
              "cssSelector": "meta[property=\\\"og:title\\\"]",
              "returnValue": "attribute",
              "attribute": "content"
            },
            {
              "key": "og_desc",
              "cssSelector": "meta[property=\\\"og:description\\\"]",
              "returnValue": "attribute",
              "attribute": "content"
            },
            {
              "key": "json_ld",
              "cssSelector": "script[type=\\\"application/ld+json\\\"]"
            },
            {
              "key": "h1_title",
              "cssSelector": "h1"
            },
            {
              "key": "page_title",
              "cssSelector": "title"
            }
          ]
        },
        "options": {}
      },
      "id": "f979a0e5-9583-421c-9212-8ddfe0c2c946",
      "name": "HTML FirstJob2",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [
        -2128,
        1696
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// --- 1. PASE VIP PARA ERRORES (Al principio de todo) ---\n// Si llega el objeto de error que creamos en el nodo anterior, lo dejamos pasar.\nconst primerItem = items[0] ? items[0].json : {};\n\nif (primerItem.es_error) {\n    return [{\n        json: {\n            fuente: \"FirstJob\",\n            es_error: true,\n            mensaje: \"Problema al consultar Google/FirstJob\",\n            link: \"ERROR_FIRSTJOB\"\n        }\n    }];\n}\n\n// --- C√ìDIGO NORMAL (Si son ofertas reales) ---\nconst linksOriginales = $('Prep Links FJ2').all(); \nconst empresasVIP = [\"Walmart\", \"Nestl√©\", \"AFP Capital\", \"Cencosud\", \"Falabella\", \"Banco de Chile\", \"Streat Food\", \"Arcoprime\", \"KPMG\", \"SGS\", \"Nubox\", \"Transbank\", \"Enel\", \"Codelco\"];\n\nreturn items.map((item, i) => {\n  const datos = item.json;\n  \n  // Recuperar Datos\n  let rawTitle = datos.og_title || datos.h1_title || datos.page_title || \"\";\n  let rawDesc  = datos.og_desc || \"\";\n  let empresa  = \"Empresa Confidencial\";\n  \n  // JSON-LD\n  if (datos.json_ld) {\n      try {\n          const jsonLimpio = JSON.parse(datos.json_ld);\n          if (jsonLimpio.hiringOrganization && jsonLimpio.hiringOrganization.name) {\n              empresa = jsonLimpio.hiringOrganization.name;\n          } else if (Array.isArray(jsonLimpio)) {\n              const job = jsonLimpio.find(o => o['@type'] === 'JobPosting');\n              if (job && job.hiringOrganization) empresa = job.hiringOrganization.name;\n          }\n      } catch (e) {}\n  }\n\n  // Limpieza T√≠tulo\n  let titulo = rawTitle\n    .replace(/\\(ID:\\s*\\d+\\)/i, \"\") \n    .replace(/\\s*-\\s*Pr√°ctica, Pasant√≠a, Internship y Primeros Trabajos/ig, \"\")\n    .replace(/\\|\\s*FirstJob/i, \"\")\n    .replace(/\\-\\s*FirstJob/i, \"\")\n    .replace(/FirstJob/i, \"\")\n    .replace(/([\\u2700-\\u27BF]|[\\uE000-\\uF8FF]|\\uD83C[\\uDC00-\\uDFFF]|\\uD83D[\\uDC00-\\uDFFF])/g, '')\n    .trim();\n\n  // Detective Empresa\n  if (empresa === \"Empresa Confidencial\") {\n      let textoGigante = (titulo + \" \" + rawDesc).toLowerCase();\n      for (const vip of empresasVIP) {\n          if (textoGigante.includes(vip.toLowerCase())) {\n              empresa = vip;\n              break;\n          }\n      }\n      if (empresa === \"Empresa Confidencial\" && rawDesc) {\n        const match = rawDesc.match(/(?:en|parte de|somos|equipo de|invita a)\\s+([A-Z√Å√â√ç√ì√ö0-9][a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö\\s\\.\\-]+?)(?:,|\\.|!|y\\s|que\\s|\\sbuscamos|\\ste\\s)/);\n        if (match && match[1]) {\n           let nombreCapturado = match[1].trim();\n           if (nombreCapturado.length < 35 && nombreCapturado.length > 2 && !nombreCapturado.toLowerCase().includes(\"pr√°ctica\")) {\n             empresa = nombreCapturado;\n           }\n        }\n      }\n  }\n\n  // Modalidad y Regi√≥n\n  let textoAnalisis = (titulo + \" \" + rawDesc).toLowerCase();\n  let modalidad = \"Presencial\"; \n  if (textoAnalisis.includes(\"remoto\")) modalidad = \"Remoto\";\n  else if (textoAnalisis.includes(\"h√≠brido\") || textoAnalisis.includes(\"hibrido\")) modalidad = \"H√≠brido\";\n\n  let region = \"Regi√≥n Metropolitana\"; \n  if (textoAnalisis.includes(\"valpara√≠so\") || textoAnalisis.includes(\"vi√±a\")) region = \"Regi√≥n de Valpara√≠so\";\n  else if (textoAnalisis.includes(\"biob√≠o\") || textoAnalisis.includes(\"concepci√≥n\")) region = \"Regi√≥n del Biob√≠o\";\n  else if (textoAnalisis.includes(\"antofagasta\")) region = \"Regi√≥n de Antofagasta\";\n\n  let link = linksOriginales[i]?.json?.link || \"https://firstjob.me\";\n\n  return {\n    json: {\n      fuente: \"FirstJob\",\n      titulo,\n      empresa, \n      region,\n      ubicacion: region,\n      modalidad,\n      link\n    }\n  };\n})\n.filter(item => {\n    // Filtro final: Si es una oferta real, debe tener t√≠tulo v√°lido\n    const t = item.json.titulo;\n    return t && t.length > 5 && !t.includes(\"Pr√°ctica, Pasant√≠a\");\n});"
      },
      "id": "56be918e-3fb4-4870-8394-d00f6b9bede3",
      "name": "Parse FirstJob2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        1696
      ]
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1088,
        2672
      ],
      "id": "9b90fa68-f3b2-46c7-b76b-591c92aaecba",
      "name": "Merge2"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Laborum\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2640,
        1968
      ],
      "id": "56e64e77-76ba-48b6-b19f-d1cc2fc3c3a0",
      "name": "Normalizar Respuesta Fuente5"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"FirstJob\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2752,
        1696
      ],
      "id": "fd549fa8-901c-4303-b6f6-31b9982c2746",
      "name": "Normalizar Respuesta Fuente6"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"FirstJob\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1872,
        1696
      ],
      "id": "bf90cd2b-135a-4349-b32e-2676f8128ef2",
      "name": "Normalizar Respuesta Fuente7"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Computrabajo\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3088,
        2304
      ],
      "id": "279cb0e8-3d11-44fd-a791-fe7a49aa16eb",
      "name": "Normalizar Respuesta Fuente8"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURACI√ìN: Cambia esto seg√∫n la rama (ej: \"FirstJob\", \"Laborum\", \"Computrabajo\")\nconst FUENTE_NOMBRE = \"Computrabajo\"; \n\nconst resultados = [];\nconst errores = [];\n\n// Analizamos la entrada del nodo HTTP/Google anterior\nfor (const item of items) {\n  const json = item.json;\n  \n  // DETECCI√ìN DE ERROR (Nativo de n8n o HTTP Status malo)\n  // Si n8n atrap√≥ un error o el status code es >= 400\n  if (json.error || (json.statusCode && json.statusCode >= 400)) {\n    errores.push({\n      fuente: FUENTE_NOMBRE,\n      es_error: true,\n      codigo: json.statusCode || json.error.code || 500, // Default a 500 si no hay c√≥digo\n      mensaje_tecnico: json.message || json.error.message || \"Error desconocido\"\n    });\n  } else {\n    // √âXITO: Pasamos el item tal cual (o procesado)\n    // Aseguramos que tenga la marca de la fuente por si acaso\n    resultados.push({\n      json: {\n        ...json,\n        fuente: FUENTE_NOMBRE,\n        es_error: false\n      }\n    });\n  }\n}\n\n// L√ìGICA DE SALIDA\n// Si hubo error, pasamos el objeto de error para que el Merge lo reciba.\n// Si hubo √©xito, pasamos los resultados.\nif (errores.length > 0) {\n  return [{ json: errores[0] }]; // Retornamos el error formateado\n}\n\nreturn resultados.map(r => ({ json: r.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2288,
        2560
      ],
      "id": "2516f340-0c8d-4d7b-b8bd-cf67e0432797",
      "name": "Normalizar Respuesta Fuente9"
    },
    {
      "parameters": {
        "jsCode": "// PARSER LABORUM ‚Äì Con \"Pase de Error\"\n\nconst item = items[0].json;\n\n// --- 1. DETECCI√ìN DE ERROR (¬°Esto es lo que faltaba!) ---\n// Si el nodo HTTP anterior fall√≥, n8n suele mandar un campo 'error' o 'statusCode' malo.\nif (item.error || (item.statusCode && item.statusCode >= 400)) {\n    // ¬°Es un error! No intentamos parsear. Pasamos la alerta roja.\n    return [{\n        json: {\n            fuente: \"Laborum\",\n            es_error: true, // Esta es la bandera que activa la caja roja\n            codigo: item.statusCode || 500,\n            mensaje: \"Error de conexi√≥n o p√°gina no encontrada (Simulado)\"\n        }\n    }];\n}\n\n// --- 2. EXTRACCI√ìN DE CONTENIDO ---\nconst rawData = item.data || item.content || \"\";\n// Convertimos a texto por si acaso llega un objeto raro\nconst raw = typeof rawData === 'object' ? JSON.stringify(rawData) : String(rawData);\n\nconst text = raw.includes(\"Markdown Content:\") \n  ? raw.split(\"Markdown Content:\")[1] \n  : raw;\n\n// --- 3. L√ìGICA DE B√öSQUEDA (Tu c√≥digo original) ---\nconst regex = /\\[([\\s\\S]*?)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g;\n\nfunction limpiarEspacios(s) {\n  return String(s || \"\").replace(/\\n+/g, \" \").replace(/\\s+/g, \" \").trim();\n}\n\nconst ofertas = [];\n\nwhile (true) {\n  const m = regex.exec(text);\n  if (!m) break;\n\n  let inside = m[1];\n  const url  = m[2].trim();\n\n  if (/\\.(jpg|jpeg|png|gif)(\\?|$)/i.test(url)) continue;\n\n  inside = limpiarEspacios(inside);\n  let segments = inside.split(\"###\").map(limpiarEspacios).filter(s => s && !s.startsWith(\"![Image\"));\n\n  if (!segments.length) continue;\n\n  let tituloRaw = segments.find(s => /Pr[a√°]ctica|Alumno/i.test(s)) || segments[0];\n  const matchTitulo = tituloRaw.match(/(Pr[a√°]ctica|Alumno[a]? en Pr[a√°]ctica)[^#]+/i);\n  let titulo = (matchTitulo ? matchTitulo[0] : tituloRaw).replace(/-{2,}.*$/, \"\").trim();\n  titulo = titulo.replace(/^\\s*(m√°s de\\s+\\d+\\s+d[i√≠]as?|[\\d.,]+\\s*(horas?|d[i√≠]as?))\\s+/i, \"\");\n\n  let empresaSeg = segments[1] || \"\";\n  if (/^(Publicado|Actualizado)/i.test(empresaSeg)) empresaSeg = \"\";\n  \n  const idxEn = empresaSeg.search(/\\sEn\\s/i);\n  if (idxEn > 0) empresaSeg = empresaSeg.slice(0, idxEn);\n  const punto = empresaSeg.indexOf(\".\");\n  if (punto > 0) empresaSeg = empresaSeg.slice(0, punto);\n\n  let empresa = limpiarEspacios(empresaSeg);\n  if (!empresa) empresa = \"Sin empresa\";\n\n  const regionCandidates = segments.filter(s => /Regi√≥n|Region/i.test(s));\n  let region = \"Sin regi√≥n\";\n  if (regionCandidates.length) {\n    regionCandidates.sort((a, b) => a.length - b.length);\n    region = limpiarEspacios(regionCandidates[0]);\n  }\n\n  let modaSeg = [...segments].reverse().find(s => /Presencial|H√≠brido|Hibrido|Remoto|Teletrabajo|Mixta/i.test(s)) || \"\";\n  let modalidad = \"Presencial\";\n  const mNorm = modaSeg.toLowerCase();\n  if (mNorm.includes(\"remoto\")) modalidad = \"Remoto\";\n  else if (mNorm.includes(\"h√≠brido\")) modalidad = \"H√≠brido\";\n\n  ofertas.push({\n    json: {\n      fuente: \"Laborum\",\n      titulo,\n      empresa,\n      region,\n      modalidad,\n      link: url,\n    },\n  });\n}\n\n// Si no hay ofertas pero tampoco era un error t√©cnico, devolvemos array vac√≠o\n// (El Build HTML se encargar√° de decir \"No hay resultados\")\nif (!ofertas.length) return [];\n\nreturn ofertas;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1744,
        2176
      ],
      "id": "03993ef9-7835-483b-a99b-97a490d4ac83",
      "name": "parser laborum1",
      "alwaysOutputData": true
    }
  ],
  "pinData": {},
  "connections": {
    "next_run1": {
      "main": [
        [
          {
            "node": "HU2 - Verificar existencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Revisar Estado1": {
      "main": [
        [
          {
            "node": "Error email1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "next_run1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HU1 - Agregar Usuario Nuevo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HU2 - Actualizar Pref.",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formulario_HU8": {
      "main": [
        [
          {
            "node": "Sanitizar2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Usuario_en_Sheet": {
      "main": [
        [
          {
            "node": "Existe_Usuario?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Existe_Usuario?": {
      "main": [
        [
          {
            "node": "Decidir_Accion_Pausar_o_Reanudar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje_NoExiste",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decidir_Accion_Pausar_o_Reanudar": {
      "main": [
        [
          {
            "node": "Ya_Esta_Pausada?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ya_Esta_Activa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ya_Esta_Pausada?": {
      "main": [
        [
          {
            "node": "Mensaje_YaPausada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ya_Esta_Activa?": {
      "main": [
        [
          {
            "node": "Mensaje_YaActiva",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Calcular_NextRun_Reanudar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular_NextRun_Reanudar": {
      "main": [
        [
          {
            "node": "Update row in sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Append row in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Append row in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU7 - Form Trigger": {
      "main": [
        [
          {
            "node": "Sanitizar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU7 - Obtener Historial": {
      "main": [
        [
          {
            "node": "HU7 - Formatear Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU7 - Formatear Respuesta": {
      "main": [
        [
          {
            "node": "HU7 - Enviar Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet4": {
      "main": [
        [
          {
            "node": "Email ya registrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Existe_Usuario?2": {
      "main": [
        [
          {
            "node": "HU7 - Obtener Historial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No existe email HU7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Usuario_en_Sheet2": {
      "main": [
        [
          {
            "node": "Existe_Usuario?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje_NoExiste": {
      "main": [
        [
          {
            "node": "No existe email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Code in JavaScript7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript7": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript8": {
      "main": [
        [
          {
            "node": "Update row in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitizar": {
      "main": [
        [
          {
            "node": "Buscar_Usuario_en_Sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitizar2": {
      "main": [
        [
          {
            "node": "Buscar_Usuario_en_Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar datos1": {
      "main": [
        [
          {
            "node": "Revisar Estado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Form de registro y Cambio de preferencias": {
      "main": [
        [
          {
            "node": "Validar datos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU2 - Verificar existencia": {
      "main": [
        [
          {
            "node": "Code in JavaScript9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU2 - Actualizar Pref.": {
      "main": [
        [
          {
            "node": "HU2 - Email ya registrado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU1 - Agregar Usuario Nuevo": {
      "main": [
        [
          {
            "node": "HU1 - Nuevo Limite Reporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU1 - Nuevo Limite Reporte": {
      "main": [
        [
          {
            "node": "HU1 - Email registro exitoso1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU2 - RegistroCambioPreferencias": {
      "main": [
        []
      ]
    },
    "HU2 - Email ya registrado1": {
      "main": [
        [
          {
            "node": "HU2 - RegistroCambioPreferencias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append row in sheet2": {
      "main": [
        [
          {
            "node": "Mensaje_Final_HU8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript9": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Send email3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HU3 - Historial Ofertas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU3 - PrepararHistorial": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitizar1": {
      "main": [
        [
          {
            "node": "Buscar_Usuario_en_Sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener next_run": {
      "main": [
        [
          {
            "node": "HU13 - Mensaje L√≠mite Alcanzado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Usuario_en_Sheet1": {
      "main": [
        [
          {
            "node": "Existe_Usuario?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Existe_Usuario?1": {
      "main": [
        [
          {
            "node": "HU13 - Get L√≠mite (HU4)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No existe email HU4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU3 - Historial Ofertas2": {
      "main": [
        [
          {
            "node": "Build HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build HTML": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - link existe (v√°lido)": {
      "main": [
        [
          {
            "node": "limpiar links",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limpiar links": {
      "main": [
        [
          {
            "node": "Remove Duplicates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar por preferencias": {
      "main": [
        [
          {
            "node": "HU3 - PrepararHistorial",
            "type": "main",
            "index": 0
          },
          {
            "node": "HU7 - Registrar Consulta2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove Duplicates": {
      "main": [
        [
          {
            "node": "Filtrar por preferencias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Get L√≠mite (HU4)": {
      "main": [
        [
          {
            "node": "HU13 - Get Consumo Actual(HU4)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Get Consumo Actual(HU4)": {
      "main": [
        [
          {
            "node": "HU13 - IF excede l√≠mite? (HU4)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Preferencias(HU4)": {
      "main": [
        [
          {
            "node": "HU4 - Build Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - IF excede l√≠mite? (HU4)": {
      "main": [
        [
          {
            "node": "HU13 - IF (exceeded?)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "HU13 - Incrementar Consumo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU4 - Build Query": {
      "main": [
        [
          {
            "node": "Google Search (FirstJob)2",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Laborum (placeholder)3",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Mensaje L√≠mite Alcanzado": {
      "main": [
        [
          {
            "node": "limite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - IF (exceeded?)": {
      "main": [
        [
          {
            "node": "Obtener next_run",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener Preferencias(HU4)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU4 - Form Trigger": {
      "main": [
        [
          {
            "node": "Sanitizar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar por next_run": {
      "main": [
        [
          {
            "node": "Normalizar payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar payload": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "HU13 - Normalizar Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Laborum (placeholder)2": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove Duplicates2": {
      "main": [
        [
          {
            "node": "Filtrar por preferencias2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar por preferencias2": {
      "main": [
        [
          {
            "node": "HU7 - Registrar Consulta",
            "type": "main",
            "index": 0
          },
          {
            "node": "HU3 - PrepararHistorial2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limpiar links2": {
      "main": [
        [
          {
            "node": "Remove Duplicates2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - link existe (v√°lido)2": {
      "main": [
        [
          {
            "node": "limpiar links2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Append row in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build HTML2": {
      "main": [
        [
          {
            "node": "Send email4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email4": {
      "main": [
        [
          {
            "node": "Bump next_run",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bump next_run": {
      "main": [
        [
          {
            "node": "Update next_run1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger2": {
      "main": [
        [
          {
            "node": "Obtener Preferencias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - IF excede l√≠mite? (Code)": {
      "main": [
        [
          {
            "node": "HU13 - IF (exceeded?)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - IF (exceeded?)2": {
      "main": [
        [
          {
            "node": "HU13 - Mensaje L√≠mite Alcanzado2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Google Search (FirstJob)1",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Laborum (placeholder)2",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Normalizar Email1": {
      "main": [
        [
          {
            "node": "HU13 - Get L√≠mite (HU6)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Get Consumo Actual1": {
      "main": [
        [
          {
            "node": "HU13 - IF excede l√≠mite? (Code)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Get L√≠mite (HU6)1": {
      "main": [
        [
          {
            "node": "HU13 - Get Consumo Actual1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU13 - Mensaje L√≠mite Alcanzado2": {
      "main": [
        [
          {
            "node": "limite2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Preferencias1": {
      "main": [
        [
          {
            "node": "Filtrar por next_run",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU3 - PrepararHistorial2": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HU3 - Historial Ofertas": {
      "main": [
        [
          {
            "node": "Build HTML2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Incrementar Consumo HU": {
      "main": [
        [
          {
            "node": "HU13 - Incrementar Consumo2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update next_run1": {
      "main": [
        [
          {
            "node": "Incrementar Consumo HU",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Send email5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HU3 - Historial Ofertas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP 2": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML2": {
      "main": [
        [
          {
            "node": "Code in JavaScript13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript13": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "Agregar Resultados2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados2": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Google Search (FirstJob)1": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Links FJ1": {
      "main": [
        [
          {
            "node": "HTTP FirstJob1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP FirstJob1": {
      "main": [
        [
          {
            "node": "HTML FirstJob1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML FirstJob1": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse FirstJob1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "If - link existe (v√°lido)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email5": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limite2": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente": {
      "main": [
        [
          {
            "node": "parser laborum",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente1": {
      "main": [
        [
          {
            "node": "Prep Links FJ1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente2": {
      "main": [
        [
          {
            "node": "Parse FirstJob1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente3": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente4": {
      "main": [
        [
          {
            "node": "HTML2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parser laborum": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "HTTP Laborum (placeholder)3": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript6": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP ": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML": {
      "main": [
        [
          {
            "node": "Code in JavaScript14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript14": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Agregar Resultados",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Google Search (FirstJob)2": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Links FJ2": {
      "main": [
        [
          {
            "node": "HTTP FirstJob2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP FirstJob2": {
      "main": [
        [
          {
            "node": "HTML FirstJob2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML FirstJob2": {
      "main": [
        [
          {
            "node": "Normalizar Respuesta Fuente7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse FirstJob2": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente5": {
      "main": [
        [
          {
            "node": "parser laborum1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente6": {
      "main": [
        [
          {
            "node": "Prep Links FJ2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente7": {
      "main": [
        [
          {
            "node": "Parse FirstJob2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente8": {
      "main": [
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Respuesta Fuente9": {
      "main": [
        [
          {
            "node": "HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parser laborum1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "If - link existe (v√°lido)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "TNhauMmfJfjOhzhr",
    "timezone": "America/Santiago"
  },
  "versionId": "18c6aa4f-5ccd-448d-8890-a70009943540",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49182ba69a2f30f291f54966c1f37e36be55c887865edaddf2d63e89079d22d9"
  },
  "id": "xaRkO5L0icDs6vMb",
  "tags": []
}